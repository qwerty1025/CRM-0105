<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¾Šå¥¶ CRM (v3.1.exp)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f1f5f9; }
        /* éš±è—æ²è»¸ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* æ•¸é‡æ¨™ç±¤å‹•ç•« */
        .qty-badge { transition: transform 0.1s; z-index: 10; }
        .qty-badge:active { transform: scale(1.2); }
        
        /* ç‹€æ…‹æ¨™ç±¤è‰²ç³» */
        .status-save { @apply bg-slate-100 text-slate-600 border-slate-300; }
        .status-billed { @apply bg-blue-50 text-blue-600 border-blue-200; }
        .status-paid { @apply bg-emerald-50 text-emerald-600 border-emerald-200; }

        /* æŒ‰éˆ•é»æ“Šæ•ˆæœ */
        .btn-active:active { transform: scale(0.96); }

        /* å½ˆçª—å‹•ç•« */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .scale-enter-active, .scale-leave-active { transition: transform 0.3s; }
        .scale-enter-from, .scale-leave-to { transform: scale(0.9); }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden flex flex-col text-slate-800 bg-slate-100">

    <div id="app" class="flex flex-col h-full w-full relative">

        <header class="bg-white/95 backdrop-blur border-b border-slate-200 px-4 py-3 flex justify-between items-center shrink-0 z-40 sticky top-0 shadow-sm transition-all">
            <div @click="reloadPage" class="font-bold text-lg text-slate-700 flex items-center gap-2 cursor-pointer hover:opacity-70 active:scale-95 transition select-none" title="é‡æ•´ v3.1.exp">
                <i class="fas fa-flask text-indigo-600"></i> 
                <span>{{ pageTitle }}</span>
                <span class="text-[9px] bg-slate-200 text-slate-500 px-1 rounded">v3.1</span>
            </div>
            
            <div class="flex gap-2">
                <button v-if="currentTab === 'list'" @click="switchToCreate" class="btn-active bg-indigo-600 text-white px-4 py-1.5 rounded-full text-sm font-bold shadow hover:bg-indigo-700 transition">
                    <i class="fas fa-plus"></i> æ–°å¢
                </button>
                <button v-if="currentTab === 'create'" @click="switchTab('list')" class="btn-active bg-white border border-slate-300 text-slate-600 px-4 py-1.5 rounded-full text-sm font-bold hover:bg-slate-50">
                    <i class="fas fa-arrow-left"></i> è¿”å›
                </button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto no-scrollbar pb-20 relative scroll-smooth bg-slate-50">

            <div v-if="currentTab === 'list'" class="min-h-full">
                <div v-if="loading" class="text-center py-10 text-slate-400"><i class="fas fa-spinner fa-spin animate-spin text-2xl mb-2"></i><br>è³‡æ–™è®€å–ä¸­...</div>
                
                <div v-else-if="sortedOrders.length === 0" class="text-center py-20 text-slate-400 flex flex-col items-center">
                    <div class="w-16 h-16 bg-slate-200 rounded-full flex items-center justify-center mb-4 text-2xl text-slate-400">
                        <i class="fas fa-folder-open"></i>
                    </div>
                    <p class="mb-2 font-bold">ç›®å‰æ²’æœ‰è³‡æ–™</p>
                    <button @click="createMockData" class="mt-2 text-xs bg-slate-200 hover:bg-slate-300 px-4 py-2 rounded-full text-slate-600 transition font-bold">
                        <i class="fas fa-magic"></i> ç”Ÿæˆæ¸¬è©¦è³‡æ–™
                    </button>
                </div>

                <div v-else class="grid grid-cols-2 gap-3 p-3 content-start">
                    <div v-for="order in sortedOrders" :key="order.id" class="bg-white rounded-xl p-3 shadow-sm border border-slate-200 relative hover:shadow-md transition flex flex-col h-full group">
                        <div class="absolute top-2 right-2">
                            <span :class="getStatusClass(order.status)" class="text-[10px] px-1.5 py-0.5 rounded border font-bold">{{ order.status }}</span>
                        </div>
                        
                        <div class="flex-1 mt-5">
                            <h3 class="font-bold text-base text-slate-800 leading-tight mb-1 truncate">{{ order.customerName }}</h3>
                            <p class="text-[10px] text-slate-400 flex items-center gap-1 truncate">
                                <i class="fas fa-map-pin text-[9px]"></i> {{ order.area || '-' }} <span class="mx-1">|</span> ${{ order.unitPrice }}/ç“¶
                            </p>
                        </div>
                        
                        <div class="mt-3 pt-2 border-t border-slate-100 flex justify-between items-end">
                            <div>
                                <div class="text-indigo-600 font-bold text-lg leading-none">${{ order.totalAmount }}</div>
                                <div class="text-[10px] text-slate-400 mt-0.5">å…± {{ order.totalCount }} ç“¶</div>
                            </div>
                            
                            <div class="flex gap-1 opacity-80 group-hover:opacity-100 transition">
                                <button @click="editOrder(order)" class="w-7 h-7 rounded-full bg-slate-50 text-slate-400 hover:bg-indigo-50 hover:text-indigo-600 transition flex items-center justify-center border border-slate-100">
                                    <i class="fas fa-pen text-[10px]"></i>
                                </button>
                                <button @click="deleteOrder(order.id)" class="w-7 h-7 rounded-full bg-slate-50 text-slate-400 hover:bg-red-50 hover:text-red-600 transition flex items-center justify-center border border-slate-100">
                                    <i class="fas fa-trash text-[10px]"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-span-2 h-10"></div>
                </div>
            </div>

            <div v-if="currentTab === 'create'" class="p-2 sm:p-4 space-y-4 max-w-5xl mx-auto">
                
                <div class="bg-white p-4 rounded-xl shadow-sm border border-indigo-100">
                    <div class="flex flex-col sm:flex-row gap-4">
                        <div class="flex-1 space-y-4">
                            <div>
                                <label class="text-xs text-slate-500 font-bold mb-1 block">é¡§å®¢å§“å (è‡ªå‹•å¸¶å…¥)</label>
                                <input type="text" v-model="form.customerName" @input="onNameInput" list="customer-list" class="w-full border-b-2 border-slate-200 py-1.5 text-lg font-bold outline-none focus:border-indigo-500 bg-transparent transition" placeholder="è«‹è¼¸å…¥å§“å">
                                <datalist id="customer-list"><option v-for="c in savedCustomers" :value="c.name"></option></datalist>
                            </div>
                            
                            <div class="flex gap-3">
                                <div class="w-1/2">
                                    <label class="text-xs text-slate-500 font-bold mb-1 block">åœ°å€</label>
                                    <input type="text" v-model="form.area" list="area-options" class="w-full bg-slate-50 rounded-lg px-3 py-2 text-sm outline-none border border-slate-200 focus:ring-1 focus:ring-indigo-500">
                                    <datalist id="area-options"><option v-for="a in uniqueAreas" :value="a"></option></datalist>
                                </div>
                                <div class="w-1/2">
                                    <label class="text-xs text-slate-500 font-bold mb-1 block">å–®åƒ¹</label>
                                    <input type="number" v-model.number="form.unitPrice" class="w-full bg-slate-50 rounded-lg px-3 py-2 text-sm outline-none border border-slate-200 focus:ring-1 focus:ring-indigo-500 text-right font-mono font-bold">
                                </div>
                            </div>
                        </div>

                        <div class="sm:w-56 bg-indigo-50/50 rounded-xl p-4 flex flex-col justify-between border border-indigo-100">
                            <div class="mb-4">
                                <div class="text-xs text-indigo-400 font-bold uppercase tracking-wider mb-1">è¨‚å–®é è¦½</div>
                                <div class="text-3xl font-bold text-indigo-700">${{ totalAmount.toLocaleString() }}</div>
                                <div class="text-sm text-indigo-500 font-medium mt-1"><i class="fas fa-wine-bottle mr-1"></i> å…± {{ totalCount }} ç“¶</div>
                            </div>
                            
                            <div class="pt-4 border-t border-indigo-100/50 space-y-2">
                                <select v-model="form.status" class="w-full text-xs p-2 rounded-lg bg-white border border-indigo-200 text-indigo-600 font-bold outline-none cursor-pointer hover:border-indigo-400 transition">
                                    <option>æš«å­˜</option>
                                    <option>å‡ºå¸³</option>
                                    <option>å…¥å¸³</option>
                                </select>
                                <button @click="saveOrder" :disabled="isSaving" class="w-full btn-active bg-indigo-600 text-white py-2.5 rounded-lg font-bold text-sm shadow-lg shadow-indigo-200 hover:bg-indigo-700 disabled:bg-slate-300 disabled:shadow-none transition flex justify-center items-center gap-2">
                                    <span v-if="!isSaving">{{ editMode ? 'æ›´æ–°è¨‚å–®' : 'å„²å­˜è¨‚å–®' }}</span>
                                    <span v-else><i class="fas fa-spinner fa-spin"></i> è™•ç†ä¸­</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white px-4 py-3 rounded-xl border border-slate-200 flex flex-col sm:flex-row items-start sm:items-center justify-between shadow-sm gap-3">
                    <div class="flex items-center gap-2 w-full overflow-x-auto no-scrollbar">
                        <span class="text-xs font-bold text-slate-500 shrink-0"><i class="fas fa-calendar-week"></i> æ˜ŸæœŸ</span>
                        <div class="flex gap-1">
                            <label v-for="day in [1, 2, 3, 4, 5]" :key="day" :class="['w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold border cursor-pointer select-none transition shadow-sm shrink-0', form.selectedDays.includes(day) ? 'bg-indigo-600 text-white border-indigo-600 scale-105' : 'bg-white text-slate-300 border-slate-200 hover:bg-slate-50']">
                                <input type="checkbox" :value="day" v-model="form.selectedDays" class="hidden" @change="generateDates">
                                {{ dayMap[day] }}
                            </label>
                        </div>
                    </div>
                    
                    <button @click="toggleAllYear" class="btn-active text-xs bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded-full font-bold border border-indigo-100 hover:bg-indigo-100 transition flex items-center gap-1 shrink-0 ml-auto">
                        <i class="fas fa-check-double"></i> å…¨é¸å¹´åº¦
                    </button>
                </div>

                <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm group">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-xs font-bold text-slate-500 flex items-center gap-1"><i class="far fa-file-alt"></i> å¸³å‹™æ‘˜è¦</label>
                        <button @click="copyBill" class="text-[10px] bg-slate-100 hover:bg-indigo-50 text-slate-500 hover:text-indigo-600 px-3 py-1 rounded-full transition font-bold">
                            <i class="far fa-copy"></i> è¤‡è£½æ–‡å­—
                        </button>
                    </div>
                    <textarea readonly v-model="generatedBillText" class="w-full h-24 text-xs font-mono bg-slate-50 border border-slate-200 rounded-lg p-3 text-slate-600 outline-none resize-none focus:bg-white focus:ring-1 focus:ring-indigo-300 transition select-all"></textarea>
                </div>

                <div class="grid grid-cols-3 gap-2 sm:gap-4 pb-8">
                    <div v-for="(monthData, mIndex) in monthsGrid" :key="mIndex" class="bg-white border border-slate-200 rounded-xl overflow-hidden flex flex-col h-full hover:border-indigo-200 transition-colors">
                        <div class="bg-slate-50/80 p-2 text-center border-b border-slate-100 flex justify-between items-center px-3">
                            <span class="text-[10px] sm:text-xs font-bold text-slate-600">{{ monthData.title }}</span>
                            <span v-if="monthData.total > 0" class="text-[9px] bg-indigo-100 text-indigo-700 px-1.5 py-0.5 rounded-full font-bold">{{ monthData.total }}</span>
                        </div>
                        <div class="p-1.5 sm:p-2 grid grid-cols-3 gap-1 content-start flex-1">
                            <div v-for="d in monthData.days" :key="d.fullDate" 
                                 @click="toggleDateQty(d)"
                                 :class="['aspect-square rounded-lg flex flex-col items-center justify-center relative cursor-pointer select-none border transition duration-200',
                                    d.qty > 0 ? 'bg-indigo-50 border-indigo-500 shadow-sm' : 'bg-white border-slate-100 hover:border-indigo-200'
                                 ]">
                                <span class="text-[10px] font-bold text-slate-700 leading-none">{{ d.dateStr }}</span>
                                <span class="text-[8px] text-slate-400 scale-90 mt-0.5">{{ d.dayStr }}</span>
                                <div v-if="d.qty > 0" class="qty-badge absolute -top-1 -right-1 w-4 h-4 bg-indigo-600 text-white rounded-full flex items-center justify-center text-[9px] font-bold shadow-sm border-2 border-white">
                                    {{ d.qty }}
                                </div>
                            </div>
                            <div v-if="monthData.days.length === 0" class="col-span-3 flex items-center justify-center h-full min-h-[40px]">
                                <span class="text-[9px] text-slate-300">ç„¡</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </main>

        <transition name="fade">
            <div v-if="modal.show" class="fixed inset-0 z-[60] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4" @click.self="closeModal">
                <transition name="scale">
                    <div v-if="modal.show" class="bg-white rounded-2xl shadow-2xl max-w-sm w-full overflow-hidden flex flex-col animate-in zoom-in-95 duration-200">
                        <div :class="['px-5 py-4 flex items-center gap-3 border-b', modal.type === 'error' ? 'bg-red-50 border-red-100' : 'bg-emerald-50 border-emerald-100']">
                            <div :class="['w-10 h-10 rounded-full flex items-center justify-center shrink-0 text-lg', modal.type === 'error' ? 'bg-red-100 text-red-600' : 'bg-emerald-100 text-emerald-600']">
                                <i :class="modal.type === 'error' ? 'fas fa-exclamation-triangle' : 'fas fa-check'"></i>
                            </div>
                            <h3 :class="['font-bold text-lg', modal.type === 'error' ? 'text-red-700' : 'text-emerald-700']">
                                {{ modal.title }}
                            </h3>
                        </div>
                        <div class="p-5">
                            <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                                <p class="text-sm text-slate-600 font-mono break-all whitespace-pre-wrap select-all">{{ modal.message }}</p>
                            </div>
                        </div>
                        <div class="px-5 pb-5 flex gap-3">
                            <button @click="copyModalContent" class="flex-1 bg-white border border-slate-300 text-slate-700 py-2.5 rounded-xl font-bold hover:bg-slate-50 transition flex justify-center items-center gap-2">
                                <i class="far fa-copy"></i> è¤‡è£½å…§å®¹
                            </button>
                            <button @click="closeModal" :class="['flex-1 py-2.5 rounded-xl font-bold text-white shadow-lg transition', modal.type === 'error' ? 'bg-red-600 hover:bg-red-700 shadow-red-200' : 'bg-emerald-600 hover:bg-emerald-700 shadow-emerald-200']">
                                ç¢ºå®š
                            </button>
                        </div>
                    </div>
                </transition>
            </div>
        </transition>

    </div>

    <script type="module">
        import { createApp, ref, computed, reactive, onMounted } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref as dbRef, push, onValue, remove, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyB6D9vh6J2mdnjz2VXEVe99oi7oLF-irFo",
            authDomain: "crm-ts-1225-001.firebaseapp.com",
            databaseURL: "https://crm-ts-1225-001-default-rtdb.firebaseio.com",
            projectId: "crm-ts-1225-001",
            storageBucket: "crm-ts-1225-001.firebasestorage.app",
            messagingSenderId: "925760221722",
            appId: "1:925760221722:web:1aeda0b82f1f16b8dcd7a3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        createApp({
            setup() {
                const currentTab = ref('list');
                const loading = ref(true);
                const isSaving = ref(false);
                const editMode = ref(false);
                const currentOrderId = ref(null);
                // â˜… ä¿®æ”¹ï¼šæ–°å¢é€±ä¸‰ã€é€±å››
                const dayMap = { 1: 'ä¸€', 2: 'äºŒ', 3: 'ä¸‰', 4: 'å››', 5: 'äº”' };
                const modal = reactive({ show: false, title: '', message: '', type: 'info' });

                const orders = ref([]);
                const savedCustomers = ref([]);
                const form = reactive({ customerName: '', area: '', unitPrice: 145, status: 'æš«å­˜', selectedDays: [1] });
                const dateList = ref([]);

                const showModal = (title, message, type = 'success') => { modal.title = title; modal.message = message; modal.type = type; modal.show = true; };
                const closeModal = () => { modal.show = false; };
                const copyModalContent = () => { navigator.clipboard.writeText(modal.message); };
                const reloadPage = () => { window.location.reload(); };

                const toSafeKey = (dateStr) => dateStr.replace(/\//g, '-');
                const fromSafeKey = (keyStr) => keyStr.replace(/-/g, '/');

                const generateDates = () => {
                    try {
                        const tempDates = [];
                        const start = new Date(2025, 0, 1);
                        const end = new Date(2025, 11, 31);
                        const activeDays = new Set(form.selectedDays); 
                        
                        const existingMap = new Map();
                        dateList.value.forEach(d => { if(d.qty > 0) existingMap.set(d.fullDate, d.qty); });

                        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                            const day = d.getDay();
                            if (activeDays.has(day)) {
                                const y = d.getFullYear();
                                const m = d.getMonth();
                                const dd = d.getDate();
                                const mStr = (m + 1).toString().padStart(2, '0');
                                const dStr = dd.toString().padStart(2, '0');
                                const fDate = `${y}/${mStr}/${dStr}`;
                                
                                tempDates.push({
                                    fullDate: fDate, monthIndex: m, dateStr: dStr, dayStr: dayMap[day],
                                    qty: existingMap.get(fDate) || 0 
                                });
                            }
                        }
                        dateList.value = tempDates;
                    } catch (e) { showModal('æ—¥æœŸéŒ¯èª¤', e.message, 'error'); }
                };

                const monthsGrid = computed(() => {
                    const grid = Array.from({ length: 12 }, (_, i) => ({ title: `2025-${(i + 1).toString().padStart(2, '0')}`, days: [], total: 0 }));
                    dateList.value.forEach(d => {
                        if(grid[d.monthIndex]) { grid[d.monthIndex].days.push(d); grid[d.monthIndex].total += d.qty; }
                    });
                    return grid;
                });

                const toggleDateQty = (d) => { if (d.qty === 0) d.qty = 1; else if (d.qty === 1) d.qty = 1.5; else if (d.qty === 1.5) d.qty = 2; else if (d.qty === 2) d.qty = 0.5; else d.qty = 0; };

                const toggleAllYear = () => {
                    const hasQty = dateList.value.some(d => d.qty > 0);
                    if(hasQty) {
                        if(confirm('æ¸…é™¤æœ¬å¹´åº¦æ‰€æœ‰å·²é¸æ—¥æœŸï¼Ÿ')) dateList.value.forEach(d => d.qty = 0);
                    } else {
                        dateList.value.forEach(d => d.qty = 1);
                    }
                };

                // â˜… ä¿®æ”¹ï¼šæ‘˜è¦å°‡åœ°å€èˆ‡å–®åƒ¹åˆä½µä¸€è¡Œ
                const generatedBillText = computed(() => {
                    const activeDates = dateList.value.filter(d => d.qty > 0);
                    if (activeDates.length === 0) return 'å°šæœªé¸æ“‡æ—¥æœŸ';
                    const grouped = {};
                    activeDates.forEach(d => {
                        const mKey = d.fullDate.substring(0, 7);
                        if (!grouped[mKey]) grouped[mKey] = [];
                        grouped[mKey].push(`${d.dateStr}(${d.dayStr})${d.qty!==1?'*'+d.qty:''}`);
                    });
                    let details = '';
                    for(const [m, ds] of Object.entries(grouped)) details += `\nã€${m}ã€‘${ds.join('ã€')}`;
                    // ä¿®æ”¹æ­¤è™•ï¼šå®¢æˆ¶èˆ‡å–®åƒ¹/åœ°å€æ•´åˆ
                    return `ğŸ§¾ å¸³å‹™æ‘˜è¦\nğŸ‘¤ å®¢æˆ¶ï¼š${form.customerName} (${form.area || '-'}) â€¢ $${form.unitPrice}/ç“¶\nğŸ”– ç‹€æ…‹ï¼š${form.status}\nğŸ’° ç¸½é‡‘é¡ï¼š$${totalAmount.value} (å…±${totalCount.value}ç“¶)\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nğŸ—“ï¸ é…é€æ˜ç´°ï¼š${details}`;
                });

                const copyBill = () => { navigator.clipboard.writeText(generatedBillText.value).then(() => showModal('è¤‡è£½æˆåŠŸ', 'å¸³å‹™æ‘˜è¦å·²è¤‡è£½')); };

                const saveOrder = async () => {
                    if (!form.customerName) { showModal('æ¬„ä½ç¼ºæ¼', 'è«‹è¼¸å…¥é¡§å®¢å§“å', 'error'); return; }
                    isSaving.value = true;
                    try {
                        const activeDates = dateList.value.filter(d => d.qty > 0);
                        const datesObj = activeDates.reduce((acc, curr) => { acc[toSafeKey(curr.fullDate)] = curr.qty; return acc; }, {});
                        const payload = {
                            customerName: form.customerName, area: form.area, unitPrice: form.unitPrice, status: form.status, selectedDays: form.selectedDays,
                            totalAmount: totalAmount.value, totalCount: totalCount.value, dates: datesObj, updatedAt: new Date().toISOString()
                        };
                        if (editMode.value && currentOrderId.value) await update(dbRef(db, `orders/${currentOrderId.value}`), payload);
                        else { payload.createdAt = new Date().toISOString(); await push(dbRef(db, 'orders'), payload); }
                        
                        const key = btoa(encodeURIComponent(form.customerName)).replace(/[^a-zA-Z0-9]/g, '');
                        await update(dbRef(db, `customers/${key}`), { name: form.customerName, area: form.area, unitPrice: form.unitPrice });
                        showModal('å„²å­˜æˆåŠŸ', `è¨‚å–®å·²${editMode.value?'æ›´æ–°':'å»ºç«‹'}å®Œç•¢`, 'success');
                        switchTab('list');
                    } catch (e) { showModal('å„²å­˜å¤±æ•—', e.message, 'error'); } finally { isSaving.value = false; }
                };

                const editOrder = (o) => {
                    try {
                        editMode.value = true; currentOrderId.value = o.id;
                        form.customerName = o.customerName; form.area = o.area || ''; form.unitPrice = o.unitPrice; 
                        form.status = (o.status && o.status.length<=2) ? o.status : 'æš«å­˜'; 
                        form.selectedDays = o.selectedDays || [1];
                        generateDates();
                        if(o.dates) dateList.value.forEach(d => { const safeKey = toSafeKey(d.fullDate); d.qty = o.dates[safeKey] || 0; });
                        switchTab('create');
                    } catch (e) { showModal('è¼‰å…¥éŒ¯èª¤', e.message, 'error'); }
                };

                const deleteOrder = async (id) => {
                    if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨‚å–®å—ï¼Ÿ')) {
                        try { await remove(dbRef(db, `orders/${id}`)); } catch(e) { showModal('åˆªé™¤å¤±æ•—', e.message, 'error'); }
                    }
                };
                
                const onNameInput = () => { const f = savedCustomers.value.find(c => c.name === form.customerName); if (f) { form.area = f.area || ''; form.unitPrice = f.unitPrice || 145; } };
                const createMockData = async () => {
                    try {
                        const mocks = [{name:'æ¸¬è©¦å®¢A',price:145,st:'æš«å­˜'}, {name:'æ¸¬è©¦å®¢B',price:145,st:'å‡ºå¸³'}];
                        for(const m of mocks) await push(dbRef(db, 'orders'), { customerName: m.name, unitPrice: m.price, status: m.st, totalAmount: 290, totalCount: 2, dates: {'2025-01-01': 2}, createdAt: new Date().toISOString() });
                        showModal('å»ºç«‹æˆåŠŸ', 'å·²ç”Ÿæˆæ¸¬è©¦è³‡æ–™', 'success');
                    } catch (e) { showModal('ç”Ÿæˆå¤±æ•—', e.message, 'error'); }
                };

                const switchTab = (t) => {
                    if (t === 'create' && !editMode.value) { form.customerName=''; form.area=''; form.unitPrice=145; form.status='æš«å­˜'; form.selectedDays=[1]; generateDates(); } 
                    else if (t === 'list') { editMode.value = false; currentOrderId.value = null; }
                    currentTab.value = t;
                };
                const switchToCreate = () => { editMode.value = false; switchTab('create'); };

                onMounted(() => {
                    onValue(dbRef(db, 'orders'), (s) => { const d = s.val(); orders.value = d ? Object.entries(d).map(([k, v]) => ({ id: k, ...v })) : []; loading.value = false; }, (e) => showModal('é€£ç·šéŒ¯èª¤', e.message, 'error'));
                    onValue(dbRef(db, 'customers'), (s) => { savedCustomers.value = s.val() ? Object.values(s.val()) : []; });
                    generateDates();
                });

                const totalCount = computed(() => dateList.value.reduce((s, d) => s + d.qty, 0));
                const totalAmount = computed(() => Math.floor(totalCount.value * form.unitPrice));
                const sortedOrders = computed(() => [...orders.value].sort((a,b) => new Date(b.updatedAt||b.createdAt)-new Date(a.updatedAt||a.createdAt)));
                const uniqueAreas = computed(() => [...new Set(savedCustomers.value.map(c => c.area).filter(Boolean))]);
                const getStatusClass = (s) => s==='å‡ºå¸³'?'status-billed':(s==='å…¥å¸³'?'status-paid':'status-save');

                return {
                    pageTitle: computed(() => currentTab.value === 'list' ? 'è¨‚å–®ç®¡ç†' : (editMode.value ? 'ä¿®æ”¹è¨‚å–®' : 'æ–°å¢è¨‚å–®')),
                    currentTab, loading, isSaving, editMode, switchTab, switchToCreate,
                    form, savedCustomers, uniqueAreas, onNameInput, dayMap, generateDates,
                    monthsGrid, toggleDateQty, modal, showModal, closeModal, copyModalContent,
                    totalCount, totalAmount, generatedBillText, copyBill, toggleAllYear,
                    sortedOrders, saveOrder, editOrder, deleteOrder,
                    getStatusClass, createMockData, reloadPage
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
