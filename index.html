<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¾Šå¥¶ CRM (v3.5.3.exp)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700;800&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'M PLUS Rounded 1c', sans-serif; 
            background-color: #fdfcf8; 
            color: #44403c;
            height: 100vh;
            overflow: hidden;
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .custom-scroll::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #d6d3d1; border-radius: 99px; }
        .custom-scroll:hover::-webkit-scrollbar-thumb { background: #a8a29e; }

        .qty-badge { transition: transform 0.1s cubic-bezier(0.34, 1.56, 0.64, 1); z-index: 10; }
        .qty-badge:active { transform: scale(1.3); }

        /* æ¨™ç±¤å¾®å‹åŒ– */
        .status-badge { @apply px-1.5 py-0.5 rounded text-[9px] font-bold border leading-none; }
        .status-save { @apply bg-stone-100 text-stone-500 border-stone-200; }
        .status-notified { @apply bg-amber-50 text-amber-600 border-amber-200; }
        .status-billed { @apply bg-blue-50 text-blue-600 border-blue-200; }
        .status-paid { @apply bg-emerald-50 text-emerald-600 border-emerald-200; }

        .type-badge { @apply text-[9px] px-1 rounded border ml-1 opacity-80 leading-none scale-90 origin-left; }
        .type-morning { @apply bg-orange-50 text-orange-600 border-orange-100; }
        .type-family { @apply bg-rose-50 text-rose-600 border-rose-100; }
        .type-group { @apply bg-violet-50 text-violet-600 border-violet-100; }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(231, 229, 228, 0.8);
        }

        .btn-press:active { transform: scale(0.97); filter: brightness(0.95); }
        .filter-checkbox:checked + span { @apply bg-emerald-600 text-white border-emerald-600; }

        /* é‡é»ä¿®æ”¹ 5: ç²—é»‘æ¡†ç·šè¨­è¨ˆ (Heavy Input) */
        .input-heavy { 
            @apply w-full bg-white border-2 border-stone-800 rounded px-2 py-0.5 text-xs font-bold text-stone-700 outline-none focus:bg-amber-50 transition-colors;
            height: 26px;
        }
        .input-micro { 
            @apply w-full bg-stone-50 border border-stone-200 rounded px-2 py-1 text-xs font-medium outline-none focus:border-emerald-400 focus:bg-white transition; 
            height: 28px;
        }
        .label-micro { @apply text-[9px] text-stone-400 font-bold mb-0.5 block uppercase tracking-wide; }

        .slide-enter-active, .slide-leave-active { transition: all 0.3s ease; max-height: 800px; opacity: 1; }
        .slide-enter-from, .slide-leave-to { max-height: 0; opacity: 0; padding: 0; margin: 0; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease-out; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col text-slate-800 bg-stone-50">

    <div id="app" class="flex flex-col h-full w-full relative">

        <header class="glass-panel px-3 py-2 flex justify-between items-center shrink-0 z-50 h-[50px]">
            <div @click="reloadPage" class="font-bold text-base text-stone-700 flex items-center gap-2 cursor-pointer select-none btn-press">
                <div class="w-6 h-6 bg-emerald-100 rounded-md flex items-center justify-center text-emerald-600"><i class="fas fa-leaf text-xs"></i></div>
                <div class="flex flex-col leading-none">
                    <span class="tracking-tight">äº”å¯®å°–</span>
                    <span class="text-[8px] text-stone-400">v3.5.3.exp</span>
                </div>
            </div>
            
            <div class="flex gap-1 items-center">
                <button @click="settingsModal.show = true" class="w-7 h-7 rounded hover:bg-stone-100 text-stone-500 transition flex items-center justify-center mr-1" title="å‡æ—¥è¨­å®š">
                    <i class="fas fa-cog text-xs"></i>
                </button>

                <div v-if="currentTab === 'list'" class="flex bg-stone-100 rounded p-0.5 mr-1">
                    <button @click="triggerImport" class="w-6 h-6 rounded hover:bg-white text-stone-500 text-[10px] transition"><i class="fas fa-file-import"></i></button>
                    <button @click="exportData" class="w-6 h-6 rounded hover:bg-white text-stone-500 text-[10px] transition"><i class="fas fa-file-export"></i></button>
                    <input type="file" ref="fileInput" class="hidden" @change="handleImport" accept=".json">
                </div>

                <button v-if="currentTab === 'create'" @click="saveOrder" :disabled="isSaving" class="btn-press bg-emerald-600 text-white px-3 py-1.5 rounded text-xs font-bold shadow-sm hover:bg-emerald-700 transition flex items-center gap-1 disabled:opacity-50">
                    <i class="fas fa-save"></i> å„²å­˜
                </button>

                <button v-if="currentTab === 'list'" @click="switchToCreate" class="btn-press bg-emerald-600 text-white w-7 h-7 rounded flex items-center justify-center shadow-sm hover:bg-emerald-700 transition">
                    <i class="fas fa-plus text-xs"></i>
                </button>
                <button v-if="currentTab === 'create'" @click="switchTab('list')" class="btn-press bg-white border border-stone-200 text-stone-500 w-7 h-7 rounded flex items-center justify-center hover:bg-stone-50 transition">
                    <i class="fas fa-times text-xs"></i>
                </button>
            </div>
        </header>

        <main class="flex-1 overflow-hidden relative flex flex-col">

            <div v-if="currentTab === 'list'" class="flex-1 flex flex-col overflow-y-auto custom-scroll p-2">
                <div class="flex flex-wrap gap-1 mb-2 sticky top-0 bg-stone-50/95 z-30 py-1 backdrop-blur">
                    <label v-for="st in statusOptions" :key="st" class="cursor-pointer">
                        <input type="checkbox" :value="st" v-model="filterStatus" class="hidden filter-checkbox">
                        <span class="px-2 py-1 rounded border border-stone-200 text-[10px] font-bold text-stone-500 bg-white transition select-none hover:border-emerald-300">
                            {{ st }}
                        </span>
                    </label>
                </div>

                <div v-if="loading" class="text-center py-20 text-stone-400 text-xs">è®€å–ä¸­...</div>
                
                <div v-else class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2 pb-10">
                    <div v-for="order in filteredOrders" :key="order.id" @click="editOrder(order)" class="bg-white rounded-lg p-2 shadow-sm border border-stone-200 relative btn-press transition hover:border-emerald-300 cursor-pointer group h-14 flex flex-col justify-between overflow-hidden">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-1 overflow-hidden">
                                <h3 class="font-bold text-sm text-stone-800 truncate">{{ order.customerName }}</h3>
                                <span v-if="order.type" :class="['type-badge', getTypeClass(order.type)]">{{ order.type }}</span>
                            </div>
                            <span :class="['status-badge scale-90 origin-right', getStatusClass(order.status)]">{{ order.status }}</span>
                        </div>
                        <div class="flex items-center justify-between text-[10px] text-stone-400 border-t border-stone-50 pt-1">
                            <div class="flex items-center gap-1 truncate max-w-[60%]">
                                <span class="bg-stone-100 px-1 rounded text-stone-500 truncate">{{ order.area || '-' }}</span>
                                <span class="font-mono text-stone-300">@{{ order.unitPrice }}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-emerald-600 font-bold">${{ order.totalAmount }}</span>
                                <span class="text-[8px] bg-stone-100 text-stone-400 px-1 rounded-full">{{ formatDateRange(order.dates) }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'create'" class="flex-1 flex flex-col lg:flex-row overflow-hidden">
                
                <div class="w-full lg:w-[280px] bg-white border-r border-stone-200 h-full flex flex-col z-20 shadow-lg lg:shadow-none overflow-hidden">
                    <div class="flex-1 overflow-y-auto custom-scroll p-3 space-y-3">
                        
                        <div class="bg-stone-50/50 rounded-lg border border-stone-200 p-2.5">
                            <div class="flex items-center gap-1 mb-2">
                                <i class="fas fa-user-circle text-stone-400 text-xs"></i>
                                <span class="text-[10px] font-bold text-stone-500 uppercase">åŸºæœ¬è³‡æ–™</span>
                            </div>
                            <div class="space-y-2">
                                <input type="text" v-model="form.customerName" @input="onNameInput" list="customer-list" class="w-full bg-white border border-stone-300 rounded px-2 py-1.5 text-sm font-bold focus:border-emerald-500 outline-none" placeholder="é¡§å®¢å§“å">
                                <datalist id="customer-list"><option v-for="c in savedCustomers" :value="c.name"></option></datalist>

                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="label-micro">åœ°å€</label>
                                        <input type="text" v-model="form.area" list="area-options" class="input-heavy">
                                        <datalist id="area-options"><option v-for="a in uniqueAreas" :value="a"></option></datalist>
                                    </div>
                                    <div>
                                        <label class="label-micro">å–®åƒ¹</label>
                                        <input type="number" v-model.number="form.unitPrice" class="input-heavy text-right">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div><label class="label-micro">é¡å‹</label><select v-model="form.type" class="input-micro text-[10px]"><option>æ™¨é–“</option><option>å®¶åº­è™Ÿ</option><option>åœ˜è³¼</option></select></div>
                                    <div><label class="label-micro">ç‹€æ…‹</label><select v-model="form.status" class="input-micro text-[10px] text-blue-600 font-bold"><option v-for="s in statusOptions" :key="s">{{ s }}</option></select></div>
                                </div>
                                <label class="flex items-center gap-2 cursor-pointer mt-1 bg-white p-1 rounded border border-stone-200">
                                    <input type="checkbox" v-model="form.ignoreHolidays" class="text-purple-600 rounded focus:ring-0">
                                    <span class="text-[10px] font-bold text-purple-600">ğŸ’œ å‡æ—¥ä¾ç„¶é…é€</span>
                                </label>
                            </div>
                        </div>

                        <div class="bg-stone-50/50 rounded-lg border border-stone-200 p-2.5">
                            <div class="flex justify-between items-end mb-2">
                                <span class="text-[10px] font-bold text-stone-500 uppercase"><i class="far fa-calendar-alt mr-1"></i>é…é€è¨­å®š</span>
                                <div class="flex gap-1">
                                    <button @click="setDays('weekday')" class="px-1.5 py-0.5 bg-white border rounded text-[9px] text-stone-500 hover:border-emerald-400">å¹³æ—¥</button>
                                    <button @click="setDays('everyday')" class="px-1.5 py-0.5 bg-white border rounded text-[9px] text-stone-500 hover:border-emerald-400">æ¯å¤©</button>
                                </div>
                            </div>
                            <div class="flex justify-between mb-2">
                                <label v-for="d in [1,2,3,4,5,6,0]" :key="d" :class="['w-6 h-6 rounded flex items-center justify-center text-[10px] font-bold cursor-pointer transition select-none border', form.selectedDays.includes(d) ? 'bg-emerald-600 text-white border-emerald-600' : 'bg-white text-stone-400 border-stone-200']">
                                    <input type="checkbox" :value="d" v-model="form.selectedDays" class="hidden" @change="generateDates">
                                    {{ dayMap[d] }}
                                </label>
                            </div>
                            <div class="flex items-center gap-1">
                                <input type="month" v-model="dateRange.start" @change="generateDates" class="input-micro w-[45%] text-[10px] text-center">
                                <span class="text-stone-300 text-[10px]">âœ</span>
                                <input type="month" v-model="dateRange.end" @change="generateDates" class="input-micro w-[45%] text-[10px] text-center">
                            </div>
                        </div>

                        <div class="bg-emerald-50/50 rounded-lg border border-emerald-100 p-2.5 flex flex-col flex-1">
                            <div class="flex justify-between items-center mb-1">
                                <div class="flex bg-white rounded p-0.5 border border-stone-100">
                                    <button @click="copyMode='A'" :class="['text-[9px] px-2 rounded transition', copyMode==='A'?'bg-emerald-100 text-emerald-700 font-bold':'text-stone-400']">æ˜ç´°</button>
                                    <button @click="copyMode='B'" :class="['text-[9px] px-2 rounded transition', copyMode==='B'?'bg-emerald-100 text-emerald-700 font-bold':'text-stone-400']">æœˆçµ</button>
                                </div>
                                <button @click="copyBill" class="text-[9px] text-emerald-600 hover:bg-emerald-100 px-2 py-0.5 rounded transition font-bold"><i class="far fa-copy"></i> è¤‡è£½</button>
                            </div>
                            <textarea readonly v-model="generatedBillText" class="w-full h-[45vh] text-[10px] font-mono bg-white border border-emerald-100 rounded p-2 text-stone-600 outline-none resize-none mb-1 shadow-inner leading-relaxed"></textarea>
                            <div class="text-right">
                                <span class="text-xs font-bold text-stone-400 mr-1">å…± {{ totalCount }} ç“¶</span>
                                <span class="text-lg font-bold text-emerald-600">${{ totalAmount.toLocaleString() }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex-1 flex flex-col h-full bg-stone-100/50 overflow-hidden">
                    <div class="flex justify-end items-center p-2 gap-2 border-b border-stone-200 bg-white/50 backdrop-blur shrink-0">
                         <span class="text-[10px] text-stone-400 mr-auto"><i class="fas fa-info-circle"></i> ç´«é»ç‚ºç‰¹æ®Šæ—¥ï¼Œé»æ“Šèª¿æ•´</span>
                         <button @click="openBatchModal" class="text-[10px] bg-white border border-amber-200 text-amber-600 px-3 py-1 rounded-full font-bold hover:bg-amber-50 transition shadow-sm">
                            <i class="fas fa-bolt"></i> æ‰¹æ¬¡å¾ªç’°
                         </button>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto custom-scroll p-3">
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3">
                            <div v-for="(monthData, mIndex) in monthsGrid" :key="mIndex" class="bg-white border border-stone-200 rounded-lg overflow-hidden flex flex-col h-full shadow-sm hover:border-emerald-300 transition">
                                <div class="bg-stone-50 p-1.5 text-center border-b border-stone-100 flex justify-between items-center px-2 cursor-pointer hover:bg-stone-100" @click="toggleMonth(monthData.days)">
                                    <span class="text-[11px] font-bold text-stone-600 font-mono">{{ monthData.title }}</span>
                                    <span v-if="monthData.total > 0" class="text-[9px] bg-emerald-100 text-emerald-700 px-1.5 rounded-full font-bold">{{ monthData.total }}</span>
                                </div>
                                <div class="p-1.5">
                                    <div class="grid grid-cols-7 mb-1 text-center border-b border-stone-50 pb-1">
                                        <span class="text-[8px] text-stone-300">æ—¥</span><span class="text-[8px] text-stone-300">ä¸€</span><span class="text-[8px] text-stone-300">äºŒ</span><span class="text-[8px] text-stone-300">ä¸‰</span><span class="text-[8px] text-stone-300">å››</span><span class="text-[8px] text-stone-300">äº”</span><span class="text-[8px] text-stone-300">å…­</span>
                                    </div>
                                    <div class="grid grid-cols-7 gap-px bg-stone-100 border border-stone-100 rounded overflow-hidden">
                                        <div v-for="n in monthData.startDay" :key="'pad-'+n" class="bg-white aspect-square"></div>
                                        <div v-for="d in monthData.days" :key="d.fullDate" 
                                             @click="d.isValid ? toggleDateQty(d) : null" 
                                             :title="d.specialReason"
                                             :class="['aspect-square flex flex-col items-center justify-center relative transition-all duration-100',
                                                d.isValid 
                                                    ? (d.qty > 0 ? 'bg-emerald-500 cursor-pointer z-10' : 'bg-white cursor-pointer hover:bg-stone-50')
                                                    : 'bg-stone-50 cursor-default'
                                             ]">
                                            <div v-if="d.isSpecial" class="absolute top-0.5 right-0.5 w-1.5 h-1.5 bg-purple-500 rounded-full z-20 shadow-sm border border-white"></div>
                                            
                                            <span :class="['text-[9px] font-bold leading-none', d.qty > 0 ? 'text-white' : (d.isValid ? 'text-stone-600' : 'text-stone-200')]">{{ d.dateStr }}</span>
                                            <div v-if="d.qty > 0" class="qty-badge absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-white text-emerald-600 rounded-full flex items-center justify-center text-[7px] font-bold shadow-sm border border-emerald-100">{{ d.qty }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </main>

        <transition name="fade">
            <div v-if="batchModal.show" class="fixed inset-0 z-[70] flex items-center justify-center bg-stone-900/60 backdrop-blur-sm p-6" @click.self="batchModal.show = false">
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden flex flex-col">
                    <div class="p-4 border-b border-stone-100 bg-stone-50 flex justify-between items-center">
                        <h3 class="font-bold text-stone-700 text-sm">é¸æ“‡æ‰¹æ¬¡ä¿®æ”¹æœˆä»½</h3>
                        <button @click="batchModal.show = false" class="text-stone-400 hover:text-stone-600"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="p-4 max-h-[60vh] overflow-y-auto custom-scroll">
                        <div class="flex justify-between mb-2 gap-2">
                            <button @click="batchModal.selected = [...batchModal.months]" class="flex-1 bg-stone-100 text-xs py-1 rounded hover:bg-stone-200">å…¨é¸</button>
                            <button @click="batchModal.selected = []" class="flex-1 bg-stone-100 text-xs py-1 rounded hover:bg-stone-200">å…¨å–æ¶ˆ</button>
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <label v-for="m in batchModal.months" :key="m" class="cursor-pointer">
                                <input type="checkbox" v-model="batchModal.selected" :value="m" class="hidden peer">
                                <div class="border border-stone-200 rounded-lg py-2 text-center text-xs font-bold text-stone-500 peer-checked:bg-amber-100 peer-checked:text-amber-700 peer-checked:border-amber-300 transition select-none">
                                    {{ m }}
                                </div>
                            </label>
                        </div>
                    </div>
                    <div class="p-4 bg-stone-50 border-t border-stone-100">
                        <button @click="applyBatch" class="w-full bg-amber-500 text-white py-2 rounded-lg text-xs font-bold hover:bg-amber-600 shadow-md shadow-amber-200">åŸ·è¡Œå¾ªç’°</button>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="settingsModal.show" class="fixed inset-0 z-[70] flex items-center justify-center bg-stone-900/60 backdrop-blur-sm p-6" @click.self="settingsModal.show = false">
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden flex flex-col h-[70vh]">
                    <div class="p-4 border-b border-stone-100 bg-stone-50 flex justify-between items-center">
                        <h3 class="font-bold text-stone-700 text-sm">åœé€æ—¥æœŸè¨­å®š (ç´«è‰²)</h3>
                        <button @click="settingsModal.show = false" class="text-stone-400 hover:text-stone-600"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="p-4 flex-1 overflow-y-auto custom-scroll space-y-3">
                        <div class="flex gap-2">
                            <input type="date" v-model="newHoliday.date" class="input-micro">
                            <input type="text" v-model="newHoliday.reason" placeholder="åŸå› " class="input-micro">
                            <button @click="addHoliday" class="bg-emerald-500 text-white rounded px-3 text-xs font-bold shadow-sm"><i class="fas fa-plus"></i></button>
                        </div>
                        <div v-for="(reason, date) in specialDays" :key="date" class="flex justify-between items-center bg-stone-50 p-2 rounded border border-stone-100">
                            <div>
                                <div class="text-[10px] font-bold text-stone-600">{{ date }}</div>
                                <div class="text-[9px] text-purple-500">{{ reason }}</div>
                            </div>
                            <button @click="delete specialDays[date]" class="text-stone-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="modal.show" class="fixed inset-0 z-[80] flex items-center justify-center bg-stone-900/40 backdrop-blur-sm p-6" @click.self="closeModal">
                <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-5 text-center transform transition-all scale-100 border border-white/50">
                    <h3 class="font-bold text-base mb-2 text-stone-800">{{ modal.title }}</h3>
                    <p class="text-xs text-stone-500 mb-5 break-all leading-relaxed">{{ modal.message }}</p>
                    <button @click="closeModal" class="w-full bg-stone-800 text-white py-2.5 rounded-xl font-bold hover:bg-stone-900 transition text-xs">ç¢ºå®š</button>
                </div>
            </div>
        </transition>

    </div>

    <script type="module">
        import { createApp, ref, computed, reactive, onMounted, watch } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref as dbRef, push, onValue, remove, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyB6D9vh6J2mdnjz2VXEVe99oi7oLF-irFo",
            authDomain: "crm-ts-1225-001.firebaseapp.com",
            databaseURL: "https://crm-ts-1225-001-default-rtdb.firebaseio.com",
            projectId: "crm-ts-1225-001",
            storageBucket: "crm-ts-1225-001.firebasestorage.app",
            messagingSenderId: "925760221722",
            appId: "1:925760221722:web:1aeda0b82f1f16b8dcd7a3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        createApp({
            setup() {
                const currentTab = ref('list');
                const loading = ref(true);
                const isSaving = ref(false);
                const editMode = ref(false);
                const currentOrderId = ref(null);
                const modal = reactive({ show: false, title: 'é€šçŸ¥', message: 'è™•ç†ä¸­...', type: 'info' });
                // â˜… æ‰¹æ¬¡å½ˆçª—
                const batchModal = reactive({ show: false, months: [], selected: [] });
                // â˜… è¨­å®šå½ˆçª— (å‡æ—¥)
                const settingsModal = reactive({ show: false });
                const newHoliday = reactive({ date: '', reason: '' });
                // â˜… å‡æ—¥è³‡æ–™ (æ¨¡æ“¬å…¨åŸŸè¨­å®š)
                const specialDays = reactive({
                    '2025-09-17': 'ä¸­ç§‹ç¯€', '2025-10-10': 'åœ‹æ…¶æ—¥', '2025-10-31': 'é¢±é¢¨å‡',
                    '2026-01-01': 'å…ƒæ—¦', '2026-02-17': 'æ˜¥ç¯€è£œå‡'
                });

                const copyMode = ref('A');
                const fileInput = ref(null);
                const orders = ref([]);
                const savedCustomers = ref([]);
                const statusOptions = ['æš«å­˜', 'å·²é€šçŸ¥', 'å·²å‡ºå¸³', 'å·²æ”¶æ¬¾'];
                const filterStatus = ref([...statusOptions]); 
                const dateRange = reactive({ start: '2025-06', end: '2026-03' });

                const form = reactive({ 
                    customerName: '', area: '', unitPrice: 30, 
                    status: 'æš«å­˜', type: 'æ™¨é–“', selectedDays: [1],
                    ignoreHolidays: false // â˜… æ–°å¢ï¼šç„¡è¦–å‡æ—¥
                });
                const quantityMap = reactive(new Map());
                const dayMap = { 1: 'ä¸€', 2: 'äºŒ', 3: 'ä¸‰', 4: 'å››', 5: 'äº”', 6: 'å…­', 0: 'æ—¥' };

                const showModal = (t='é€šçŸ¥', m='å®Œæˆ', type='success') => { modal.title = t; modal.message = m; modal.type = type; modal.show = true; };
                const closeModal = () => { modal.show = false; };
                const copyModalContent = () => navigator.clipboard.writeText(modal.message);
                const reloadPage = () => window.location.reload();

                const exportData = () => {
                    const dataStr = JSON.stringify(orders.value, null, 2);
                    const blob = new Blob([dataStr], { type: "application/json" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a'); a.href = url; a.download = `crm.json`; a.click();
                };
                const triggerImport = () => fileInput.value.click();
                const handleImport = (e) => {
                    const file = e.target.files[0]; if(!file) return;
                    const reader = new FileReader();
                    reader.onload = async (ev) => {
                        try {
                            const data = JSON.parse(ev.target.result);
                            if(Array.isArray(data) && confirm(`åŒ¯å…¥ ${data.length} ç­†ï¼Ÿ`)) {
                                for(const item of data) { const { id, ...c } = item; await push(dbRef(db, 'orders'), c); }
                                showModal('åŒ¯å…¥æˆåŠŸ', `æˆåŠŸ ${data.length} ç­†`);
                            }
                        } catch(err) { showModal('åŒ¯å…¥å¤±æ•—', err.message, 'error'); }
                    };
                    reader.readAsText(file);
                };

                const addHoliday = () => {
                    if(newHoliday.date && newHoliday.reason) {
                        specialDays[newHoliday.date] = newHoliday.reason;
                        newHoliday.date = ''; newHoliday.reason = '';
                    }
                };

                const toSafeKey = (d) => d.replace(/\//g, '-');
                
                // â˜… 4-6 Months Grid View Logic
                const monthsGrid = computed(() => {
                    if (!dateRange.start || !dateRange.end) return [];
                    const [sy, sm] = dateRange.start.split('-').map(Number);
                    const [ey, em] = dateRange.end.split('-').map(Number);
                    const start = new Date(sy, sm - 1, 1);
                    const end = new Date(ey, em, 0);
                    
                    const activeDays = new Set(form.selectedDays);
                    const grids = [];
                    let current = new Date(start);

                    while (current <= end) {
                        const y = current.getFullYear();
                        const m = current.getMonth();
                        const mStr = (m + 1).toString().padStart(2, '0');
                        const monthKey = `${y}-${mStr}`;
                        const daysInMonth = new Date(y, m + 1, 0).getDate();
                        const firstDayOfWeek = new Date(y, m, 1).getDay();
                        
                        const days = [];
                        let totalQty = 0;

                        for (let d = 1; d <= daysInMonth; d++) {
                            const dStr = d.toString().padStart(2, '0');
                            const fDate = `${y}/${mStr}/${dStr}`;
                            const fDateDash = `${y}-${mStr}-${dStr}`; // Key for specialDays
                            const dayOfWeek = new Date(y, m, d).getDay();
                            
                            const isValid = activeDays.has(dayOfWeek);
                            const isSpecial = !!specialDays[fDateDash]; // â˜… Check Special
                            const specialReason = specialDays[fDateDash];

                            // â˜… Auto 0 if special and not ignored
                            let qty = quantityMap.get(fDate) || 0;
                            // Note: logic implies we set qty, but strictly we just read here.
                            // However, visually user should see what's happening.
                            // If isSpecial and !ignoreHolidays, maybe we shouldn't count it?
                            // But better to let user manually toggle or batch set.
                            // Here we just mark it visually.
                            
                            if (isValid) totalQty += qty;

                            const dateObj = new Date(y, m, d);
                            dateObj.setHours(0,0,0,0);
                            dateObj.setDate(dateObj.getDate() + 3 - (dateObj.getDay() + 6) % 7);
                            const w1 = new Date(dateObj.getFullYear(), 0, 4);
                            const wk = 1 + Math.round(((dateObj.getTime() - w1.getTime()) / 86400000 - 3 + (w1.getDay() + 6) % 7) / 7);

                            days.push({
                                fullDate: fDate, dateStr: dStr, dayStr: dayOfWeek,
                                qty: qty, isValid: isValid, weekNum: wk,
                                isSpecial: isSpecial, specialReason: specialReason
                            });
                        }
                        grids.push({ title: monthKey, days: days, startDay: firstDayOfWeek, total: totalQty });
                        current = new Date(y, m + 1, 1);
                    }
                    return grids;
                });

                const toggleDateQty = (d) => { 
                    let q = d.qty; 
                    if (q === 0) q = 1;
                    else if (q === 1) q = 2;
                    else if (q === 2) q = 1.5;
                    else q = 0;
                    quantityMap.set(d.fullDate, q);
                };
                
                const toggleMonth = (days) => {
                    const validDays = days.filter(d => d.isValid);
                    if(validDays.length === 0) return;
                    const hasQty = validDays.some(d => quantityMap.get(d.fullDate) > 0);
                    validDays.forEach(d => quantityMap.set(d.fullDate, hasQty ? 0 : 1));
                };

                const openBatchModal = () => {
                    batchModal.months = monthsGrid.value.map(m => m.title);
                    // â˜… Default Select 9-12
                    batchModal.selected = batchModal.months.filter(m => {
                        const mo = parseInt(m.split('-')[1]);
                        return mo >= 9 && mo <= 12;
                    });
                    batchModal.show = true;
                };

                const applyBatch = () => {
                    if (batchModal.selected.length === 0) return;
                    
                    let firstVal = 0;
                    const firstSelectedMonth = monthsGrid.value.find(m => m.title === batchModal.selected[0]);
                    if (firstSelectedMonth) {
                        const found = firstSelectedMonth.days.find(d => d.isValid);
                        if(found) firstVal = quantityMap.get(found.fullDate) || 0;
                    }
                    let n = 0;
                    if (firstVal === 0) n = 1; else if (firstVal === 1) n = 2; else if (firstVal === 2) n = 1.5; else n = 0;

                    const targets = new Set(batchModal.selected);
                    monthsGrid.value.forEach(m => {
                        if (targets.has(m.title)) {
                            m.days.forEach(d => { 
                                // â˜… Skip special days if not ignored
                                if(d.isValid) {
                                    if(d.isSpecial && !form.ignoreHolidays) {
                                        // Do nothing or set 0? Usually keep as is or set 0. 
                                        // Let's set 0 for safety on holidays.
                                        quantityMap.set(d.fullDate, 0);
                                    } else {
                                        quantityMap.set(d.fullDate, n); 
                                    }
                                }
                            });
                        }
                    });
                    batchModal.show = false;
                };

                const setDays = (type) => {
                    if(type === 'weekday') form.selectedDays = [1,2,3,4,5];
                    else form.selectedDays = [0,1,2,3,4,5,6];
                };

                const totalCount = computed(() => {
                    let sum = 0;
                    for (const q of quantityMap.values()) sum += q;
                    return sum;
                });
                const totalAmount = computed(() => Math.floor(totalCount.value * form.unitPrice));

                const generatedBillText = computed(() => {
                    const active = [];
                    const sortedKeys = Array.from(quantityMap.keys()).sort();
                    for(const k of sortedKeys) {
                        if(quantityMap.get(k) > 0) {
                            const [y,m,d] = k.split('/');
                            const dateObj = new Date(y, m-1, d);
                            dateObj.setHours(0,0,0,0);
                            dateObj.setDate(dateObj.getDate() + 3 - (dateObj.getDay() + 6) % 7);
                            const w1 = new Date(dateObj.getFullYear(), 0, 4);
                            const wk = 1 + Math.round(((dateObj.getTime() - w1.getTime()) / 86400000 - 3 + (w1.getDay() + 6) % 7) / 7);
                            const dayMapStr = {0:'æ—¥',1:'ä¸€',2:'äºŒ',3:'ä¸‰',4:'å››',5:'äº”',6:'å…­'};
                            active.push({
                                fullDate: k, dateStr: d, dayStr: dayMapStr[new Date(y, m-1, d).getDay()],
                                qty: quantityMap.get(k), weekNum: wk
                            });
                        }
                    }

                    if (active.length === 0) return 'å°šæœªé¸æ“‡æ—¥æœŸ';
                    const firstDate = active[0].fullDate;
                    const header = firstDate.substring(0, 7).replace('/', '-');
                    const byMonth = {};
                    active.forEach(d => {
                        const k = d.fullDate.substring(0, 7);
                        if (!byMonth[k]) byMonth[k] = [];
                        byMonth[k].push(d);
                    });

                    let details = '';
                    if (copyMode.value === 'A') {
                        for(const [mKey, dates] of Object.entries(byMonth)) {
                            const [y, m] = mKey.split('/');
                            details += `\nğŸ”º ${y}å¹´${m}æœˆä»½\n`;
                            const byWeek = {};
                            dates.forEach(d => { if(!byWeek[d.weekNum]) byWeek[d.weekNum]=[]; byWeek[d.weekNum].push(d); });
                            Object.keys(byWeek).sort((a,b)=>a-b).forEach(wk => {
                                details += byWeek[wk].map(d => `${parseInt(m)}/${d.dateStr}(${d.dayStr})${d.qty!==1?'*'+d.qty:''}`).join('ï¼Œ') + '\n';
                            });
                        }
                    } else {
                        details += '\næ¯æ—¥é…é€ï¼š(ä¾æ˜ç´°)\n';
                        for(const [mKey, dates] of Object.entries(byMonth)) {
                            const [y, m] = mKey.split('/');
                            const sum = dates.reduce((a,b)=>a+b.qty,0);
                            const days = dates.length;
                            details += `${parseInt(m)} æœˆï½œ${days} å¤©ï¼Œåˆè¨ˆï¼š${sum} ç“¶\n\n`;
                        }
                    }
                    return `ç¾Šå¥¶é…é€å¸³å–®\nï¼ˆ${header} èµ·ï¼‰\né¡§å®¢ï¼š${form.customerName}\nè¨ˆåƒ¹ï¼šæ¯ç“¶ NT$${form.unitPrice}\n${details}â€”â€”\nç¸½è¨ˆï¼š${totalCount.value} ç“¶ï¼Œæ‡‰æ”¶ï¼šNT$${totalAmount.value}`;
                });

                const copyBill = () => { navigator.clipboard.writeText(generatedBillText.value).then(() => showModal('è¤‡è£½æˆåŠŸ', 'å·²è¤‡è£½')); };

                const saveOrder = async () => {
                    if (!form.customerName) { showModal('éŒ¯èª¤', 'è«‹è¼¸å…¥å§“å'); return; }
                    isSaving.value = true;
                    try {
                        const datesObj = {};
                        for (const [k, v] of quantityMap.entries()) { if(v > 0) datesObj[toSafeKey(k)] = v; }
                        const payload = {
                            customerName: form.customerName, area: form.area, unitPrice: form.unitPrice,
                            status: form.status, type: form.type, selectedDays: form.selectedDays,
                            totalAmount: totalAmount.value, totalCount: totalCount.value, dates: datesObj, updatedAt: new Date().toISOString(),
                            ignoreHolidays: form.ignoreHolidays // Save Setting
                        };
                        if (editMode.value && currentOrderId.value) await update(dbRef(db, `orders/${currentOrderId.value}`), payload);
                        else { payload.createdAt = new Date().toISOString(); await push(dbRef(db, 'orders'), payload); }
                        
                        const key = btoa(encodeURIComponent(form.customerName)).replace(/[^a-zA-Z0-9]/g, '');
                        await update(dbRef(db, `customers/${key}`), { 
                            name: form.customerName, area: form.area, unitPrice: form.unitPrice,
                            type: form.type, status: form.status, ignoreHolidays: form.ignoreHolidays
                        });
                        showModal('æˆåŠŸ', 'å„²å­˜å®Œç•¢');
                        switchTab('list');
                    } catch (e) { showModal('å¤±æ•—', e.message, 'error'); } finally { isSaving.value = false; }
                };

                const editOrder = (o) => {
                    editMode.value = true; currentOrderId.value = o.id;
                    form.customerName = o.customerName; form.area = o.area || ''; form.unitPrice = o.unitPrice;
                    form.status = (o.status && o.status.length<=4) ? o.status : 'æš«å­˜';
                    form.type = o.type || 'æ™¨é–“'; form.selectedDays = o.selectedDays || [1];
                    form.ignoreHolidays = o.ignoreHolidays || false;
                    quantityMap.clear();
                    if(o.dates) { for(const [k, v] of Object.entries(o.dates)) { quantityMap.set(k.replace(/-/g, '/'), v); } }
                    switchTab('create');
                };

                const deleteOrder = async (id) => { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) await remove(dbRef(db, `orders/${id}`)); };
                
                const onNameInput = () => { 
                    const f = savedCustomers.value.find(c => c.name === form.customerName); 
                    if (f) { 
                        form.area = f.area || ''; form.unitPrice = f.unitPrice || 30;
                        if(f.type) form.type=f.type; if(f.status) form.status=f.status; 
                        form.ignoreHolidays = f.ignoreHolidays || false;
                    } 
                };
                const createMockData = async () => {
                    const mocks = [{name:'é˜¿é³³å§‘å§‘',price:25,st:'å·²æ”¶æ¬¾',tp:'æ™¨é–“'}];
                    for(const m of mocks) await push(dbRef(db, 'orders'), { 
                        customerName: m.name, unitPrice: m.price, status: m.st, type: m.tp,
                        totalAmount: 18250, totalCount: 730, dates: {'2025-01-01': 2}, createdAt: new Date().toISOString() 
                    });
                    showModal('æˆåŠŸ', 'å·²å»ºç«‹ç¯„ä¾‹');
                };

                const switchTab = (t) => {
                    if (t === 'create' && !editMode.value) { 
                        form.customerName=''; form.area=''; form.unitPrice=30; 
                        form.status='æš«å­˜'; form.type='æ™¨é–“'; form.selectedDays=[1]; form.ignoreHolidays=false;
                        quantityMap.clear();
                    } 
                    else if (t === 'list') { editMode.value = false; currentOrderId.value = null; }
                    currentTab.value = t;
                };
                const switchToCreate = () => { editMode.value = false; switchTab('create'); };

                onMounted(() => {
                    onValue(dbRef(db, 'orders'), (s) => { const d = s.val(); orders.value = d ? Object.entries(d).map(([k, v]) => ({ id: k, ...v })) : []; loading.value = false; });
                    onValue(dbRef(db, 'customers'), (s) => { savedCustomers.value = s.val() ? Object.values(s.val()) : []; });
                });

                const filteredOrders = computed(() => {
                    return orders.value.filter(o => filterStatus.value.includes(o.status)).sort((a,b) => new Date(b.updatedAt||b.createdAt)-new Date(a.updatedAt||a.createdAt));
                });

                const formatDateRange = (dates) => {
                    if (!dates) return '';
                    const keys = Object.keys(dates).sort();
                    if (keys.length === 0) return '';
                    const start = keys[0].replace(/-/g, '/');
                    const end = keys[keys.length - 1].replace(/-/g, '/');
                    return `${start} ~ ${end}`;
                };

                const uniqueAreas = computed(() => [...new Set(savedCustomers.value.map(c => c.area).filter(Boolean))]);
                const getStatusClass = (s) => { switch(s){ case 'æš«å­˜':return 'status-save'; case 'å·²é€šçŸ¥':return 'status-notified'; case 'å·²å‡ºå¸³':return 'status-billed'; case 'å·²æ”¶æ¬¾':return 'status-paid'; default:return 'status-save'; }};
                const getTypeClass = (t) => { switch(t){ case 'åœ˜è³¼':return 'type-group'; case 'å®¶åº­è™Ÿ':return 'type-family'; default:return 'type-morning'; }};

                return {
                    pageTitle: computed(() => currentTab.value === 'list' ? 'è¨‚å–®ç®¡ç†' : (editMode.value ? 'ä¿®æ”¹è¨‚å–®' : 'æ–°å¢è¨‚å–®')),
                    currentTab, loading, isSaving, editMode, switchTab, switchToCreate,
                    form, savedCustomers, uniqueAreas, onNameInput, dayMap,
                    monthsGrid, toggleDateQty, modal, showModal, closeModal, copyModalContent,
                    totalCount, totalAmount, generatedBillText, copyBill, 
                    openBatchModal, applyBatch, batchModal, 
                    toggleMonth, setDays, settingsModal, newHoliday, addHoliday, specialDays,
                    saveOrder, editOrder, deleteOrder, formatDateRange,
                    getStatusClass, getTypeClass, createMockData, reloadPage, copyMode,
                    exportData, handleImport, triggerImport, fileInput,
                    statusOptions, filterStatus, filteredOrders, dateRange
                };
            }
        }).mount('#app');
    </script>
</body>
</html>