<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>羊奶 CRM (Grid版)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f1f5f9; }
        /* 隱藏捲軸 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* 數量標籤動畫 */
        .qty-badge { transition: transform 0.1s; z-index: 10; }
        .qty-badge:active { transform: scale(1.2); }
        
        /* 狀態標籤色系 */
        .status-save { @apply bg-slate-100 text-slate-600 border-slate-300; }
        .status-billed { @apply bg-blue-50 text-blue-600 border-blue-200; }
        .status-paid { @apply bg-emerald-50 text-emerald-600 border-emerald-200; }

        /* 按鈕點擊效果 */
        .btn-active:active { transform: scale(0.96); }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden flex flex-col text-slate-800 bg-slate-100">

    <div id="app" class="flex flex-col h-full w-full">

        <header class="bg-white border-b border-slate-200 px-4 py-3 flex justify-between items-center shrink-0 z-20 shadow-sm">
            <h1 class="font-bold text-lg text-slate-700 flex items-center gap-2">
                <i class="fas fa-th text-indigo-600"></i> {{ pageTitle }}
            </h1>
            <div class="flex gap-2">
                <button v-if="currentTab === 'list'" @click="switchToCreate" class="btn-active bg-indigo-600 text-white px-4 py-1.5 rounded-full text-sm font-bold shadow hover:bg-indigo-700 transition">
                    <i class="fas fa-plus"></i> 新增
                </button>
                <button v-if="currentTab === 'create'" @click="switchTab('list')" class="btn-active bg-white border border-slate-300 text-slate-600 px-4 py-1.5 rounded-full text-sm font-bold hover:bg-slate-50">
                    <i class="fas fa-arrow-left"></i> 返回
                </button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto no-scrollbar pb-10">

            <div v-if="currentTab === 'list'" class="p-4 space-y-4">
                <div v-if="loading" class="text-center py-10 text-slate-400"><i class="fas fa-spinner fa-spin"></i> 讀取中...</div>
                
                <div v-else-if="sortedOrders.length === 0" class="text-center py-20 text-slate-400">
                    <div class="mb-4 text-4xl"><i class="fas fa-folder-open"></i></div>
                    <p>尚無訂單，請點擊右上角新增</p>
                    <button @click="createMockData" class="mt-4 text-xs bg-slate-200 px-3 py-1 rounded text-slate-600">生成測試資料</button>
                </div>

                <div v-for="order in sortedOrders" :key="order.id" class="bg-white rounded-xl p-4 shadow-sm border border-slate-200 relative">
                    <div class="absolute top-4 right-4">
                        <span :class="getStatusClass(order.status)" class="text-xs px-2 py-1 rounded border font-bold">{{ order.status }}</span>
                    </div>
                    <h3 class="font-bold text-lg">{{ order.customerName }}</h3>
                    <p class="text-xs text-slate-400">{{ order.area }} • ${{ order.unitPrice }}/瓶</p>
                    
                    <div class="mt-3 pt-3 border-t flex justify-between items-end">
                        <div class="text-indigo-600 font-bold text-xl">${{ order.totalAmount }} <span class="text-xs text-slate-400 font-normal">({{ order.totalCount }}瓶)</span></div>
                        <div class="flex gap-2">
                            <button @click="editOrder(order)" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 hover:bg-blue-100 hover:text-blue-600"><i class="fas fa-pen text-xs"></i></button>
                            <button @click="deleteOrder(order.id)" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 hover:bg-red-100 hover:text-red-600"><i class="fas fa-trash text-xs"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'create'" class="p-2 sm:p-4 space-y-4 max-w-5xl mx-auto">
                
                <div class="bg-white p-4 rounded-xl shadow-sm border border-indigo-100">
                    <div class="flex flex-col sm:flex-row gap-4">
                        <div class="flex-1 space-y-3">
                            <div>
                                <label class="text-xs text-slate-500 font-bold">顧客姓名 (自動帶入)</label>
                                <input type="text" v-model="form.customerName" @input="onNameInput" list="customer-list" class="w-full border-b border-slate-300 py-1 text-lg font-bold outline-none focus:border-indigo-500 bg-transparent" placeholder="輸入姓名">
                                <datalist id="customer-list"><option v-for="c in savedCustomers" :value="c.name"></option></datalist>
                            </div>
                            
                            <div class="flex gap-3">
                                <div class="w-1/2">
                                    <label class="text-xs text-slate-500 font-bold">地區</label>
                                    <input type="text" v-model="form.area" list="area-options" class="w-full bg-slate-50 rounded px-2 py-1 text-sm outline-none border border-slate-200">
                                    <datalist id="area-options"><option v-for="a in uniqueAreas" :value="a"></option></datalist>
                                </div>
                                <div class="w-1/2">
                                    <label class="text-xs text-slate-500 font-bold">單價</label>
                                    <input type="number" v-model.number="form.unitPrice" class="w-full bg-slate-50 rounded px-2 py-1 text-sm outline-none border border-slate-200 text-right font-mono">
                                </div>
                            </div>
                        </div>

                        <div class="sm:w-48 bg-indigo-50 rounded-lg p-3 flex flex-col justify-between border border-indigo-100">
                            <div>
                                <div class="text-xs text-indigo-400 font-bold uppercase">訂單總計</div>
                                <div class="text-2xl font-bold text-indigo-700">${{ totalAmount.toLocaleString() }}</div>
                                <div class="text-sm text-indigo-500 font-medium">共 {{ totalCount }} 瓶</div>
                            </div>
                            
                            <div class="mt-3 pt-3 border-t border-indigo-200">
                                <select v-model="form.status" class="w-full text-xs mb-2 p-1 rounded bg-white border border-indigo-200 text-indigo-600 font-bold outline-none">
                                    <option>暫時儲存</option>
                                    <option>登記出帳</option>
                                    <option>確認入帳</option>
                                </select>
                                <button @click="saveOrder" :disabled="isSaving" class="w-full btn-active bg-indigo-600 text-white py-2 rounded-lg font-bold text-sm shadow-md hover:bg-indigo-700 disabled:bg-slate-300 flex justify-center gap-2">
                                    <span v-if="!isSaving">{{ editMode ? '更新' : '儲存' }}</span>
                                    <span v-else><i class="fas fa-spinner fa-spin"></i></span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white px-4 py-2 rounded-lg border border-slate-200 flex items-center justify-between">
                    <span class="text-xs font-bold text-slate-500">快速篩選</span>
                    <div class="flex gap-2">
                        <label v-for="day in [1, 2, 5]" :key="day" :class="['w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold border cursor-pointer select-none transition', form.selectedDays.includes(day) ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-slate-300 border-slate-200']">
                            <input type="checkbox" :value="day" v-model="form.selectedDays" class="hidden" @change="generateDates">
                            {{ dayMap[day] }}
                        </label>
                    </div>
                </div>

                <div class="bg-white p-3 rounded-xl border border-slate-200">
                    <div class="flex justify-between items-center mb-1">
                        <label class="text-xs font-bold text-slate-500"><i class="far fa-file-alt"></i> 帳務摘要</label>
                        <button @click="copyBill" class="text-[10px] bg-slate-100 hover:bg-slate-200 text-slate-600 px-2 py-0.5 rounded transition">
                            <i class="far fa-copy"></i> 複製文字
                        </button>
                    </div>
                    <textarea readonly v-model="generatedBillText" class="w-full h-24 text-xs font-mono bg-slate-50 border border-slate-200 rounded p-2 text-slate-600 outline-none resize-none"></textarea>
                </div>

                <div class="grid grid-cols-3 gap-2 sm:gap-4">
                    <div v-for="(monthData, mIndex) in monthsGrid" :key="mIndex" class="bg-white border border-slate-200 rounded-lg overflow-hidden flex flex-col h-full">
                        
                        <div class="bg-slate-50 p-1.5 text-center border-b border-slate-100 flex justify-between items-center px-2">
                            <span class="text-xs font-bold text-slate-700">{{ monthData.title }}</span>
                            <span v-if="monthData.total > 0" class="text-[10px] bg-indigo-100 text-indigo-700 px-1.5 rounded-full font-bold">{{ monthData.total }}</span>
                        </div>

                        <div class="p-1.5 grid grid-cols-3 gap-1 content-start flex-1">
                            <div v-for="d in monthData.days" :key="d.fullDate" 
                                 @click="toggleDateQty(d)"
                                 :class="['aspect-square rounded flex flex-col items-center justify-center relative cursor-pointer select-none border transition',
                                    d.qty > 0 ? 'bg-indigo-50 border-indigo-500 shadow-sm' : 'bg-white border-slate-100'
                                 ]">
                                <span class="text-[10px] font-bold text-slate-600">{{ d.dateStr }}</span>
                                <span class="text-[8px] text-slate-400 scale-90">{{ d.dayStr }}</span>
                                
                                <div v-if="d.qty > 0" class="qty-badge absolute -top-1 -right-1 w-4 h-4 bg-indigo-600 text-white rounded-full flex items-center justify-center text-[9px] font-bold shadow-sm border border-white">
                                    {{ d.qty }}
                                </div>
                            </div>
                            
                            <div v-if="monthData.days.length === 0" class="col-span-3 text-[10px] text-slate-300 text-center py-4">
                                無排程
                            </div>
                        </div>
                    </div>
                </div>

                <div class="h-10"></div>
            </div>

        </main>
    </div>

    <script type="module">
        import { createApp, ref, computed, reactive, onMounted } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref as dbRef, push, onValue, remove, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // 您的 Config
        const firebaseConfig = {
            apiKey: "AIzaSyB6D9vh6J2mdnjz2VXEVe99oi7oLF-irFo",
            authDomain: "crm-ts-1225-001.firebaseapp.com",
            databaseURL: "https://crm-ts-1225-001-default-rtdb.firebaseio.com",
            projectId: "crm-ts-1225-001",
            storageBucket: "crm-ts-1225-001.firebasestorage.app",
            messagingSenderId: "925760221722",
            appId: "1:925760221722:web:1aeda0b82f1f16b8dcd7a3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        createApp({
            setup() {
                // UI 狀態
                const currentTab = ref('list');
                const loading = ref(true);
                const isSaving = ref(false);
                const editMode = ref(false);
                const currentOrderId = ref(null);
                const dayMap = { 1: '一', 2: '二', 5: '五' };

                // 資料庫資料
                const orders = ref([]);
                const savedCustomers = ref([]);
                
                // 表單資料
                const form = reactive({
                    customerName: '',
                    area: '',
                    unitPrice: 35,
                    status: '暫時儲存',
                    selectedDays: [1]
                });
                
                // 核心：所有日期的平面列表 (flat list)
                const dateList = ref([]);

                // --- 1. 日期與 Grid 生成邏輯 ---
                const generateDates = () => {
                    const tempDates = [];
                    const start = new Date(2025, 0, 1); // 2025/01/01
                    const end = new Date(2025, 11, 31); // 2025/12/31
                    const activeDays = new Set(form.selectedDays); 
                    
                    // 記憶舊數量
                    const existingMap = new Map();
                    dateList.value.forEach(d => { if(d.qty > 0) existingMap.set(d.fullDate, d.qty); });

                    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                        const day = d.getDay();
                        if (activeDays.has(day)) {
                            const y = d.getFullYear();
                            const m = d.getMonth(); // 0-11
                            const dd = d.getDate();
                            // 格式化
                            const mStr = (m + 1).toString().padStart(2, '0');
                            const dStr = dd.toString().padStart(2, '0');
                            const fDate = `${y}/${mStr}/${dStr}`;
                            
                            tempDates.push({
                                fullDate: fDate,
                                monthIndex: m, // 0-11 用於分組
                                dateStr: dStr,
                                dayStr: dayMap[day],
                                qty: existingMap.get(fDate) || 0 
                            });
                        }
                    }
                    dateList.value = tempDates;
                };

                // 將平面日期轉為 12 個月的結構，供 v-for 渲染 Grid
                const monthsGrid = computed(() => {
                    // 初始化 12 個月空陣列
                    const grid = Array.from({ length: 12 }, (_, i) => ({
                        title: `2025-${(i + 1).toString().padStart(2, '0')}`,
                        days: [],
                        total: 0
                    }));

                    // 填入日期
                    dateList.value.forEach(d => {
                        grid[d.monthIndex].days.push(d);
                        grid[d.monthIndex].total += d.qty;
                    });
                    return grid;
                });

                // 點擊切換數量
                const toggleDateQty = (d) => {
                    // 0 -> 1 -> 1.5 -> 2 -> 0.5 -> 0
                    if (d.qty === 0) d.qty = 1;
                    else if (d.qty === 1) d.qty = 1.5;
                    else if (d.qty === 1.5) d.qty = 2;
                    else if (d.qty === 2) d.qty = 0.5;
                    else d.qty = 0;
                };

                // --- 2. 摘要文字計算 ---
                const generatedBillText = computed(() => {
                    const activeDates = dateList.value.filter(d => d.qty > 0);
                    if (activeDates.length === 0) return '尚未選擇日期';
                    
                    // 按月分組字串
                    const grouped = {};
                    activeDates.forEach(d => {
                        const mKey = d.fullDate.substring(0, 7); // 2025/01
                        if (!grouped[mKey]) grouped[mKey] = [];
                        grouped[mKey].push(`${d.dateStr}(${d.dayStr})${d.qty!==1?'*'+d.qty:''}`);
                    });

                    let details = '';
                    for(const [m, ds] of Object.entries(grouped)) {
                        details += `\n【${m}】${ds.join('、')}`;
                    }

                    return `客戶：${form.customerName}\n狀態：${form.status}\n總計：${totalCount.value}瓶 / $${totalAmount.value}\n----------------${details}`;
                });

                const copyBill = () => {
                    navigator.clipboard.writeText(generatedBillText.value).then(() => alert('已複製摘要'));
                };

                // --- 3. CRUD ---
                const saveOrder = async () => {
                    if (!form.customerName) { alert('請輸入姓名'); return; }
                    isSaving.value = true;
                    
                    const activeDates = dateList.value.filter(d => d.qty > 0);
                    const payload = {
                        customerName: form.customerName,
                        area: form.area,
                        unitPrice: form.unitPrice,
                        status: form.status,
                        selectedDays: form.selectedDays,
                        totalAmount: totalAmount.value,
                        totalCount: totalCount.value,
                        // 儲存格式: { "2025/01/01": 1.5 }
                        dates: activeDates.reduce((acc, curr) => {
                            acc[curr.fullDate] = curr.qty;
                            return acc;
                        }, {}),
                        updatedAt: new Date().toISOString()
                    };

                    try {
                        if (editMode.value && currentOrderId.value) {
                            await update(dbRef(db, `orders/${currentOrderId.value}`), payload);
                        } else {
                            payload.createdAt = new Date().toISOString();
                            await push(dbRef(db, 'orders'), payload);
                        }
                        
                        // 存顧客
                        const key = btoa(encodeURIComponent(form.customerName)).replace(/[^a-zA-Z0-9]/g, '');
                        await update(dbRef(db, `customers/${key}`), { 
                            name: form.customerName, area: form.area, unitPrice: form.unitPrice 
                        });

                        alert('✅ 儲存成功');
                        switchTab('list');
                    } catch (e) {
                        alert('錯誤: ' + e.message);
                    } finally {
                        isSaving.value = false;
                    }
                };

                const editOrder = (o) => {
                    editMode.value = true;
                    currentOrderId.value = o.id;
                    form.customerName = o.customerName;
                    form.area = o.area || '';
                    form.unitPrice = o.unitPrice;
                    form.status = o.status;
                    form.selectedDays = o.selectedDays || [1];
                    generateDates();
                    
                    // 回填數量
                    if(o.dates) {
                        dateList.value.forEach(d => {
                            d.qty = o.dates[d.fullDate] || 0;
                        });
                    }
                    switchTab('create');
                };

                const deleteOrder = (id) => { if(confirm('確定刪除?')) remove(dbRef(db, `orders/${id}`)); };
                
                // --- Helpers ---
                const onNameInput = () => {
                    const f = savedCustomers.value.find(c => c.name === form.customerName);
                    if (f) { form.area = f.area || ''; form.unitPrice = f.unitPrice || 35; }
                };

                const createMockData = async () => {
                    const mocks = [{name:'測試客A',price:35,st:'暫時儲存'}, {name:'測試客B',price:40,st:'登記出帳'}];
                    for(const m of mocks) {
                        await push(dbRef(db, 'orders'), {
                            customerName: m.name, unitPrice: m.price, status: m.st, totalAmount: 100, totalCount: 2,
                            dates: {'2025/01/01': 2}, createdAt: new Date().toISOString()
                        });
                    }
                };

                const switchTab = (t) => {
                    if (t === 'create') { 
                        // 重置表單
                        if (!editMode.value) {
                             form.customerName=''; form.area=''; form.unitPrice=35; 
                             form.status='暫時儲存'; form.selectedDays=[1];
                             generateDates();
                        }
                    } else {
                        editMode.value = false;
                        currentOrderId.value = null;
                    }
                    currentTab.value = t;
                };

                const switchToCreate = () => { editMode.value = false; switchTab('create'); };

                // Lifecycle
                onMounted(() => {
                    onValue(dbRef(db, 'orders'), (s) => { 
                        const d = s.val(); 
                        orders.value = d ? Object.entries(d).map(([k, v]) => ({ id: k, ...v })) : [];
                        loading.value = false;
                    });
                    onValue(dbRef(db, 'customers'), (s) => {
                        savedCustomers.value = s.val() ? Object.values(s.val()) : [];
                    });
                    generateDates();
                });

                // Computed
                const totalCount = computed(() => dateList.value.reduce((s, d) => s + d.qty, 0));
                const totalAmount = computed(() => Math.floor(totalCount.value * form.unitPrice));
                const sortedOrders = computed(() => [...orders.value].sort((a,b) => new Date(b.updatedAt||b.createdAt)-new Date(a.updatedAt||a.createdAt)));
                const uniqueAreas = computed(() => [...new Set(savedCustomers.value.map(c => c.area).filter(Boolean))]);
                const getStatusClass = (s) => s==='登記出帳'?'status-billed':(s==='確認入帳'?'status-paid':'status-save');

                return {
                    pageTitle: computed(() => currentTab.value === 'list' ? '訂單管理' : (editMode.value ? '修改訂單' : '新增訂單')),
                    currentTab, loading, isSaving, editMode, switchTab, switchToCreate,
                    form, savedCustomers, uniqueAreas, onNameInput, dayMap, generateDates,
                    monthsGrid, toggleDateQty,
                    totalCount, totalAmount, generatedBillText, copyBill,
                    sortedOrders, saveOrder, editOrder, deleteOrder,
                    getStatusClass, createMockData
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
