<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¾Šå¥¶ CRM (å®¶åº­è™Ÿç‰ˆ)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f8fafc; }
        /* éš±è—æ²è»¸ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* æ•¸é‡æ¨™ç±¤å‹•ç•« */
        .qty-badge { transition: transform 0.1s; z-index: 10; }
        .qty-badge:active { transform: scale(1.3); }
        
        /* ç‹€æ…‹è† å›Š (Pills) æ¨£å¼ */
        .pill { @apply px-3 py-1.5 rounded-full text-xs font-bold border transition cursor-pointer select-none text-center whitespace-nowrap; }
        .pill-default { @apply bg-slate-100 text-slate-500 border-slate-200 hover:bg-slate-200; }
        
        /* æ¿€æ´»ç‹€æ…‹é¡è‰² */
        .pill-active-save { @apply bg-slate-600 text-white border-slate-600; }
        .pill-active-billed { @apply bg-blue-600 text-white border-blue-600; }
        .pill-active-paid { @apply bg-emerald-600 text-white border-emerald-600; }

        /* æ ¼å­é»æ“Šæ•ˆæœ */
        .grid-item:active { transform: scale(0.95); }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden flex flex-col text-slate-800 bg-slate-50">

    <div id="app" class="flex flex-col h-full w-full">

        <header class="bg-white border-b border-slate-200 px-4 py-3 flex justify-between items-center shrink-0 z-20 shadow-sm safe-top">
            <h1 class="font-bold text-lg text-slate-700 flex items-center gap-2">
                <i class="fas fa-wine-bottle text-indigo-600"></i> {{ pageTitle }}
            </h1>
            <div class="flex gap-2">
                <button v-if="currentTab === 'list'" @click="switchToCreate" class="bg-indigo-600 text-white px-4 py-1.5 rounded-full text-sm font-bold shadow active:scale-95 transition">
                    <i class="fas fa-plus"></i> æ–°å¢
                </button>
                <button v-if="currentTab === 'create'" @click="switchTab('list')" class="bg-white border border-slate-300 text-slate-600 px-4 py-1.5 rounded-full text-sm font-bold active:scale-95 transition">
                    <i class="fas fa-arrow-left"></i> åˆ—è¡¨
                </button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto no-scrollbar pb-20">

            <div v-if="currentTab === 'list'" class="p-4 space-y-4">
                <div v-if="loading" class="text-center py-12 text-slate-400">
                    <i class="fas fa-circle-notch fa-spin text-2xl"></i><br>è³‡æ–™è®€å–ä¸­...
                </div>
                
                <div v-else-if="sortedOrders.length === 0" class="flex flex-col items-center justify-center py-16 text-slate-400">
                    <i class="fas fa-inbox text-4xl mb-2 text-slate-300"></i>
                    <p class="text-sm">å°šç„¡è³‡æ–™</p>
                    <button @click="createMockData" class="mt-4 text-xs bg-indigo-50 text-indigo-600 px-3 py-1 rounded-full border border-indigo-100">
                        âœ¨ ç”Ÿæˆ 950g æ¸¬è©¦å–®
                    </button>
                </div>

                <div v-for="order in sortedOrders" :key="order.id" class="bg-white rounded-xl p-4 shadow-sm border border-slate-200 relative">
                    <div class="absolute top-4 right-4">
                        <span :class="getStatusBadgeClass(order.status)" class="text-[10px] px-2 py-1 rounded border font-bold">
                            {{ order.status }}
                        </span>
                    </div>

                    <h3 class="font-bold text-lg">{{ order.customerName }}</h3>
                    <div class="text-xs text-slate-400 mt-0.5 flex items-center gap-2">
                        <span>{{ order.area || 'æœªåˆ†é¡' }}</span>
                        <span class="w-1 h-1 bg-slate-300 rounded-full"></span>
                        <span>950g å®¶åº­è™Ÿ (${{ order.unitPrice }})</span>
                    </div>
                    
                    <div class="mt-4 pt-3 border-t border-slate-100 flex justify-between items-end">
                        <div>
                            <div class="text-2xl font-bold text-slate-800">${{ order.totalAmount.toLocaleString() }}</div>
                            <div class="text-[10px] text-slate-400">ç¸½è¨ˆ {{ order.totalCount }} ç“¶</div>
                        </div>
                        <div class="flex gap-2">
                            <button @click="editOrder(order)" class="w-9 h-9 rounded-full bg-indigo-50 text-indigo-600 hover:bg-indigo-100 flex items-center justify-center transition"><i class="fas fa-pen text-xs"></i></button>
                            <button @click="deleteOrder(order.id)" class="w-9 h-9 rounded-full bg-rose-50 text-rose-500 hover:bg-rose-100 flex items-center justify-center transition"><i class="fas fa-trash text-xs"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'create'" class="p-3 sm:p-5 space-y-5 max-w-3xl mx-auto">
                
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs text-slate-400 font-bold uppercase tracking-wider">é¡§å®¢å§“å</label>
                            <input type="text" v-model="form.customerName" @input="onNameInput" list="customer-list" class="w-full text-xl font-bold border-b border-slate-200 py-1 outline-none focus:border-indigo-500 bg-transparent placeholder-slate-300" placeholder="è¼¸å…¥æˆ–é¸æ“‡">
                            <datalist id="customer-list"><option v-for="c in savedCustomers" :value="c.name"></option></datalist>
                        </div>

                        <div class="flex gap-4">
                            <div class="w-1/2">
                                <label class="text-xs text-slate-400 font-bold">åœ°å€</label>
                                <input type="text" v-model="form.area" list="area-options" class="w-full bg-slate-50 border border-slate-200 rounded px-3 py-2 text-sm outline-none focus:border-indigo-400">
                                <datalist id="area-options"><option v-for="a in uniqueAreas" :value="a"></option></datalist>
                            </div>
                            <div class="w-1/2">
                                <label class="text-xs text-slate-400 font-bold">å–®åƒ¹ (å®¶åº­è™Ÿ)</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-2 text-slate-400 text-xs">$</span>
                                    <input type="number" v-model.number="form.unitPrice" class="w-full bg-slate-50 border border-slate-200 rounded pl-6 pr-3 py-2 text-sm font-bold text-right outline-none focus:border-indigo-400">
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="text-xs text-slate-400 font-bold block mb-2">æºé€šé€²åº¦</label>
                            <div class="flex flex-wrap gap-2">
                                <button v-for="st in statusOptions" :key="st" 
                                    @click="form.status = st"
                                    :class="['pill', form.status === st ? getPillActiveClass(st) : 'pill-default']">
                                    {{ st }}
                                    <i v-if="form.status === st" class="fas fa-check ml-1 text-[10px]"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-indigo-600 rounded-xl p-4 text-white shadow-lg shadow-indigo-200 flex justify-between items-center">
                    <div>
                        <div class="text-xs opacity-80 mb-0.5">é ä¼°ç¸½é‡‘é¡ ({{ totalCount }} ç“¶)</div>
                        <div class="text-3xl font-bold">${{ totalAmount.toLocaleString() }}</div>
                    </div>
                    <button @click="saveOrder" :disabled="isSaving" class="bg-white text-indigo-600 px-6 py-2.5 rounded-full font-bold shadow-sm active:scale-95 transition disabled:opacity-50 flex items-center gap-2">
                        <span v-if="!isSaving">{{ editMode ? 'æ›´æ–°è¨‚å–®' : 'å»ºç«‹è¨‚å–®' }}</span>
                        <span v-else><i class="fas fa-spinner fa-spin"></i></span>
                    </button>
                </div>

                <div class="bg-slate-100 p-3 rounded-xl border border-slate-200">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-xs font-bold text-slate-500"><i class="fab fa-line text-green-500 text-sm"></i> è¨Šæ¯æ‘˜è¦</label>
                        <button @click="copyBill" class="text-[10px] bg-white border border-slate-300 text-slate-600 px-2 py-1 rounded shadow-sm active:bg-slate-50">
                            è¤‡è£½æ–‡å­—
                        </button>
                    </div>
                    <textarea readonly v-model="generatedBillText" class="w-full h-28 text-[11px] leading-relaxed font-mono bg-white border border-slate-200 rounded p-2 text-slate-600 outline-none resize-none"></textarea>
                </div>

                <div class="flex justify-end gap-2 px-1">
                     <label v-for="day in [1, 2, 5]" :key="day" :class="['w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold border cursor-pointer select-none transition shadow-sm', form.selectedDays.includes(day) ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-slate-400 border-slate-200']">
                        <input type="checkbox" :value="day" v-model="form.selectedDays" class="hidden" @change="generateDates">
                        {{ dayMap[day] }}
                    </label>
                </div>

                <div class="grid grid-cols-3 gap-2">
                    <div v-for="(monthData, mIndex) in monthsGrid" :key="mIndex" class="bg-white border border-slate-200 rounded-lg overflow-hidden flex flex-col h-full shadow-sm">
                        
                        <div class="bg-slate-50 px-2 py-1.5 border-b border-slate-100 flex justify-between items-center">
                            <span class="text-[10px] font-bold text-slate-500">{{ monthData.title }}</span>
                            <span v-if="monthData.total > 0" class="text-[9px] bg-indigo-100 text-indigo-700 px-1.5 py-0.5 rounded-full font-bold">{{ monthData.total }}</span>
                        </div>

                        <div class="p-1 grid grid-cols-3 gap-1 content-start flex-1 min-h-[60px]">
                            <div v-for="d in monthData.days" :key="d.fullDate" 
                                 @click="toggleDateQty(d)"
                                 :class="['grid-item aspect-square rounded flex flex-col items-center justify-center relative cursor-pointer select-none border transition',
                                    d.qty > 0 ? 'bg-indigo-50 border-indigo-400' : 'bg-white border-slate-100'
                                 ]">
                                <span class="text-[10px] font-bold text-slate-700 leading-none">{{ d.dateStr }}</span>
                                <span class="text-[8px] text-slate-400 scale-90 leading-none mt-0.5">{{ d.dayStr }}</span>
                                
                                <div v-if="d.qty > 0" class="qty-badge absolute -top-1 -right-1 w-4 h-4 bg-indigo-600 text-white rounded-full flex items-center justify-center text-[9px] font-bold border border-white shadow-sm">
                                    {{ d.qty }}
                                </div>
                            </div>
                            
                            <div v-if="monthData.days.length === 0" class="col-span-3 flex items-center justify-center text-[9px] text-slate-300 h-full">
                                -
                            </div>
                        </div>
                    </div>
                </div>

                <div class="h-10"></div>
            </div>

        </main>
    </div>

    <script type="module">
        import { createApp, ref, computed, reactive, onMounted } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref as dbRef, push, onValue, remove, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Firebase Config (ç¶­æŒåŸæ¨£)
        const firebaseConfig = {
            apiKey: "AIzaSyB6D9vh6J2mdnjz2VXEVe99oi7oLF-irFo",
            authDomain: "crm-ts-1225-001.firebaseapp.com",
            databaseURL: "https://crm-ts-1225-001-default-rtdb.firebaseio.com",
            projectId: "crm-ts-1225-001",
            storageBucket: "crm-ts-1225-001.firebasestorage.app",
            messagingSenderId: "925760221722",
            appId: "1:925760221722:web:1aeda0b82f1f16b8dcd7a3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        createApp({
            setup() {
                const currentTab = ref('list');
                const loading = ref(true);
                const isSaving = ref(false);
                const editMode = ref(false);
                const currentOrderId = ref(null);
                const dayMap = { 1: 'ä¸€', 2: 'äºŒ', 5: 'äº”' };
                const statusOptions = ['æš«æ™‚å„²å­˜', 'ç™»è¨˜å‡ºå¸³', 'ç¢ºèªå…¥å¸³'];

                const orders = ref([]);
                const savedCustomers = ref([]);
                
                const form = reactive({
                    customerName: '', area: '', 
                    unitPrice: 145, // é è¨­ 950g å®¶åº­è™Ÿåƒ¹æ ¼
                    status: 'æš«æ™‚å„²å­˜', 
                    selectedDays: [1]
                });
                
                const dateList = ref([]);

                // 1. ç”Ÿæˆ Grid è³‡æ–™ (å¹³é¢è½‰çµæ§‹)
                const generateDates = () => {
                    const tempDates = [];
                    const start = new Date(2025, 0, 1);
                    const end = new Date(2025, 11, 31);
                    const activeDays = new Set(form.selectedDays); 
                    
                    const existingMap = new Map();
                    dateList.value.forEach(d => { if(d.qty > 0) existingMap.set(d.fullDate, d.qty); });

                    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                        const day = d.getDay();
                        if (activeDays.has(day)) {
                            const y = d.getFullYear();
                            const m = d.getMonth();
                            const dd = d.getDate();
                            tempDates.push({
                                fullDate: `${y}/${(m+1).toString().padStart(2,'0')}/${dd.toString().padStart(2,'0')}`,
                                monthIndex: m,
                                dateStr: dd.toString().padStart(2,'0'),
                                dayStr: dayMap[day],
                                qty: existingMap.get(`${y}/${(m+1).toString().padStart(2,'0')}/${dd.toString().padStart(2,'0')}`) || 0 
                            });
                        }
                    }
                    dateList.value = tempDates;
                };

                const monthsGrid = computed(() => {
                    const grid = Array.from({ length: 12 }, (_, i) => ({
                        title: `${i + 1}æœˆ`,
                        days: [], total: 0
                    }));
                    dateList.value.forEach(d => {
                        grid[d.monthIndex].days.push(d);
                        grid[d.monthIndex].total += d.qty;
                    });
                    return grid;
                });

                const toggleDateQty = (d) => {
                    if (d.qty === 0) d.qty = 1;
                    else if (d.qty === 1) d.qty = 1.5;
                    else if (d.qty === 1.5) d.qty = 2;
                    else if (d.qty === 2) d.qty = 0.5;
                    else d.qty = 0;
                };

                // 2. LINE æ‘˜è¦ç”¢ç”Ÿå™¨ (Emoji & Format)
                const generatedBillText = computed(() => {
                    const activeDates = dateList.value.filter(d => d.qty > 0);
                    if (activeDates.length === 0) return 'å°šæœªé¸æ“‡é…é€æ—¥æœŸ';
                    
                    const grouped = {};
                    activeDates.forEach(d => {
                        const mKey = d.fullDate.substring(5, 7); // å–æœˆä»½ "01"
                        if (!grouped[mKey]) grouped[mKey] = [];
                        // 1.5ç“¶é¡¯ç¤ºç‚º *1.5, 1ç“¶ä¸é¡¯ç¤ºæ•¸é‡
                        const qStr = d.qty !== 1 ? `*${d.qty}` : '';
                        grouped[mKey].push(`${d.dateStr}(${d.dayStr})${qStr}`);
                    });

                    let details = '';
                    for(const [m, ds] of Object.entries(grouped)) {
                        details += `\nã€${m}æœˆã€‘${ds.join('ã€')}`;
                    }

                    return `ğŸ“ ç¾Šå¥¶é…é€ç¢ºèªå–® (950gå®¶åº­è™Ÿ)
ğŸ‘¤ å®¢æˆ¶ï¼š${form.customerName}
ğŸ“ åœ°å€ï¼š${form.area || 'æœªå¡«å¯«'}
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“Š ç‹€æ…‹ï¼š${form.status}
ğŸ’° ç¸½é‡‘é¡ï¼š$${totalAmount.value.toLocaleString()} (å…± ${totalCount.value} ç“¶)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ—“ï¸ é…é€æ—¥æœŸæ˜ç´°ï¼š
${details}

âš ï¸ è‹¥æœ‰è®Šå‹•è«‹æå‰å‘ŠçŸ¥ï¼Œè¬è¬ï¼`;
                });

                const copyBill = () => {
                    navigator.clipboard.writeText(generatedBillText.value).then(() => alert('å·²è¤‡è£½æ‘˜è¦ï¼è«‹è²¼ä¸Š LINE'));
                };

                // 3. CRUD (ç¶­æŒä¸è®Š)
                const saveOrder = async () => {
                    if (!form.customerName) { alert('è«‹è¼¸å…¥å§“å'); return; }
                    isSaving.value = true;
                    
                    const activeDates = dateList.value.filter(d => d.qty > 0);
                    const payload = {
                        customerName: form.customerName, area: form.area, unitPrice: form.unitPrice, status: form.status, selectedDays: form.selectedDays,
                        totalAmount: totalAmount.value, totalCount: totalCount.value,
                        dates: activeDates.reduce((acc, curr) => { acc[curr.fullDate] = curr.qty; return acc; }, {}),
                        updatedAt: new Date().toISOString()
                    };

                    try {
                        if (editMode.value && currentOrderId.value) {
                            await update(dbRef(db, `orders/${currentOrderId.value}`), payload);
                        } else {
                            payload.createdAt = new Date().toISOString();
                            await push(dbRef(db, 'orders'), payload);
                        }
                        // Upsert Customer
                        const key = btoa(encodeURIComponent(form.customerName)).replace(/[^a-zA-Z0-9]/g, '');
                        await update(dbRef(db, `customers/${key}`), { name: form.customerName, area: form.area, unitPrice: form.unitPrice });
                        
                        alert('âœ… å„²å­˜æˆåŠŸ');
                        switchTab('list');
                    } catch (e) { alert('éŒ¯èª¤: ' + e.message); } finally { isSaving.value = false; }
                };

                const editOrder = (o) => {
                    editMode.value = true; currentOrderId.value = o.id;
                    form.customerName = o.customerName; form.area = o.area || ''; form.unitPrice = o.unitPrice; form.status = o.status; form.selectedDays = o.selectedDays || [1];
                    generateDates();
                    if(o.dates) dateList.value.forEach(d => d.qty = o.dates[d.fullDate] || 0);
                    switchTab('create');
                };
                const deleteOrder = (id) => { if(confirm('ç¢ºå®šåˆªé™¤?')) remove(dbRef(db, `orders/${id}`)); };
                const onNameInput = () => { const f = savedCustomers.value.find(c => c.name === form.customerName); if (f) { form.area = f.area || ''; form.unitPrice = f.unitPrice || 145; } };
                
                const createMockData = async () => {
                    await push(dbRef(db, 'orders'), {
                        customerName: 'æ¸¬è©¦å®¶åº­æˆ¶', area: 'ç¤¾å€A', unitPrice: 145, status: 'æš«æ™‚å„²å­˜', totalAmount: 290, totalCount: 2,
                        dates: {'2025/01/06': 1, '2025/01/13': 1}, createdAt: new Date().toISOString()
                    });
                };

                const switchTab = (t) => {
                    if (t === 'create' && !editMode.value) {
                         form.customerName=''; form.area=''; form.unitPrice=145; 
                         form.status='æš«æ™‚å„²å­˜'; form.selectedDays=[1]; generateDates();
                    } else if (t === 'list') { editMode.value = false; currentOrderId.value = null; }
                    currentTab.value = t;
                };
                const switchToCreate = () => { editMode.value = false; switchTab('create'); };

                onMounted(() => {
                    onValue(dbRef(db, 'orders'), (s) => { const d = s.val(); orders.value = d ? Object.entries(d).map(([k, v]) => ({ id: k, ...v })) : []; loading.value = false; });
                    onValue(dbRef(db, 'customers'), (s) => { savedCustomers.value = s.val() ? Object.values(s.val()) : []; });
                    generateDates();
                });

                // Helpers
                const totalCount = computed(() => dateList.value.reduce((s, d) => s + d.qty, 0));
                const totalAmount = computed(() => Math.floor(totalCount.value * form.unitPrice));
                const sortedOrders = computed(() => [...orders.value].sort((a,b) => new Date(b.updatedAt||b.createdAt)-new Date(a.updatedAt||a.createdAt)));
                const uniqueAreas = computed(() => [...new Set(savedCustomers.value.map(c => c.area).filter(Boolean))]);
                
                const getStatusBadgeClass = (s) => s==='ç™»è¨˜å‡ºå¸³'?'bg-blue-50 text-blue-600 border-blue-200':(s==='ç¢ºèªå…¥å¸³'?'bg-emerald-50 text-emerald-600 border-emerald-200':'bg-slate-100 text-slate-500 border-slate-200');
                const getPillActiveClass = (s) => s==='ç™»è¨˜å‡ºå¸³'?'pill-active-billed':(s==='ç¢ºèªå…¥å¸³'?'pill-active-paid':'pill-active-save');

                return {
                    pageTitle: computed(() => currentTab.value === 'list' ? 'å®¶åº­è™Ÿè¨‚å–®ç®¡ç†' : (editMode.value ? 'ä¿®æ”¹è¨‚å–®' : 'æ–°å¢è¨‚å–®')),
                    currentTab, loading, isSaving, editMode, switchTab, switchToCreate,
                    form, savedCustomers, uniqueAreas, onNameInput, dayMap, generateDates, monthsGrid, toggleDateQty,
                    totalCount, totalAmount, generatedBillText, copyBill, sortedOrders, saveOrder, editOrder, deleteOrder,
                    getStatusBadgeClass, getPillActiveClass, statusOptions, createMockData
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
