<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¾Šå¥¶ CRM (ç¾å­¸å‡ç´šç‰ˆ)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* 1. åŸºç¤è¨­å®šï¼šå­—å‹èˆ‡èƒŒæ™¯è‰²æ”¹ç‚ºæº«æš–è‰²èª¿ */
        body { 
            font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background-color: #fdfcf8; /* ç±³ç™½è‰²èƒŒæ™¯ */
            color: #44403c; /* Stone-700 æº«æ½¤çš„æ·±ç° */
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .qty-badge { transition: transform 0.1s cubic-bezier(0.34, 1.56, 0.64, 1); z-index: 10; }
        .qty-badge:active { transform: scale(1.3); }

        /* 2. ç‹€æ…‹æ¨™ç±¤ï¼šæ”¹ç‚ºæŸ”å’Œç²‰å½©ç³» */
        .status-badge { @apply px-2 py-1 rounded-lg text-[10px] font-bold border; }
        .status-save { @apply bg-stone-100 text-stone-500 border-stone-200; }
        .status-billed { @apply bg-sky-50 text-sky-600 border-sky-100; }
        .status-paid { @apply bg-emerald-50 text-emerald-600 border-emerald-100; }

        /* 3. å®¢æˆ¶é¡å‹æ¨™ç±¤ï¼šå¤§åœ°è‰²ç³» */
        .type-badge { @apply px-2 py-1 rounded-lg text-[10px] font-bold border ml-1; }
        .type-morning { @apply bg-orange-50 text-orange-600 border-orange-100; } /* æ™¨æ›¦ */
        .type-family { @apply bg-rose-50 text-rose-600 border-rose-100; }   /* æº«é¦¨ */
        .type-group { @apply bg-violet-50 text-violet-600 border-violet-100; } /* åœ˜é«” */

        /* 4. æŒ‰éˆ•äº’å‹•å„ªåŒ– */
        .btn-press:active { transform: scale(0.97); filter: brightness(0.95); }

        /* 5. å¡ç‰‡ç»ç’ƒè³ªæ„Ÿèˆ‡é™°å½± */
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 4px 20px -2px rgba(215, 210, 200, 0.4);
        }
        
        /* å½ˆçª—å‹•ç•« */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease-out; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .scale-enter-active, .scale-leave-active { transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .scale-enter-from, .scale-leave-to { transform: scale(0.9); opacity: 0; }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden flex flex-col">

    <div id="app" class="flex flex-col h-full w-full relative">

        <header class="glass-panel border-b-0 px-4 py-4 flex justify-between items-center shrink-0 z-40 sticky top-0 mx-2 mt-2 rounded-2xl">
            <div @click="reloadPage" class="font-bold text-lg text-stone-700 flex items-center gap-2 cursor-pointer select-none btn-press">
                <div class="w-8 h-8 bg-emerald-100 rounded-full flex items-center justify-center text-emerald-600">
                    <i class="fas fa-leaf"></i>
                </div>
                <div class="flex flex-col leading-none">
                    <span class="text-sm">äº”å¯®å°–å±±ç¾Šä¹³</span>
                    <span class="text-[9px] text-stone-400 font-normal">CRM v3.2</span>
                </div>
            </div>
            
            <div class="flex gap-2">
                <button v-if="currentTab === 'list'" @click="switchToCreate" class="btn-press bg-emerald-500 text-white px-4 py-2 rounded-xl text-xs font-bold shadow-lg shadow-emerald-200 hover:bg-emerald-600 transition flex items-center gap-1">
                    <i class="fas fa-plus"></i> æ–°å¢
                </button>
                <button v-if="currentTab === 'create'" @click="switchTab('list')" class="btn-press bg-white border border-stone-200 text-stone-500 px-4 py-2 rounded-xl text-xs font-bold hover:bg-stone-50">
                    <i class="fas fa-arrow-left"></i> åˆ—è¡¨
                </button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto no-scrollbar pb-24 pt-4 px-2 relative scroll-smooth">

            <div v-if="currentTab === 'list'" class="min-h-full px-1">
                <div v-if="loading" class="text-center py-20 text-stone-400 flex flex-col items-center animate-pulse">
                    <i class="fas fa-circle-notch fa-spin text-2xl mb-3 text-emerald-400"></i>
                    <span class="text-xs tracking-widest">è¼‰å…¥ç‰§å ´è³‡æ–™ä¸­...</span>
                </div>
                
                <div v-else-if="sortedOrders.length === 0" class="text-center py-20 text-stone-400 flex flex-col items-center">
                    <div class="w-20 h-20 bg-stone-100 rounded-full flex items-center justify-center mb-4 text-3xl text-stone-300 shadow-inner">
                        <i class="fas fa-wind"></i>
                    </div>
                    <p class="mb-4 font-bold text-stone-500">å°šç„¡è¨‚å–®è³‡æ–™</p>
                    <button @click="createMockData" class="btn-press text-xs bg-white border border-stone-200 px-5 py-2.5 rounded-full text-stone-600 shadow-sm font-medium">
                        <i class="fas fa-magic text-amber-400 mr-1"></i> ç”Ÿæˆç¯„ä¾‹
                    </button>
                </div>

                <div v-else class="grid grid-cols-2 gap-3 pb-8 content-start">
                    <div v-for="order in sortedOrders" :key="order.id" class="bg-white rounded-3xl p-4 shadow-sm border border-stone-100 relative btn-press transition-all duration-300 flex flex-col h-full group hover:shadow-md hover:border-emerald-100">
                        
                        <div class="flex flex-wrap gap-1 mb-2 items-start justify-end">
                            <span :class="['status-badge', getStatusClass(order.status)]">{{ order.status }}</span>
                            <span v-if="order.type" :class="['type-badge', getTypeClass(order.type)]">{{ order.type }}</span>
                        </div>
                        
                        <div class="flex-1">
                            <h3 class="font-bold text-base text-stone-700 leading-tight mb-1 truncate">{{ order.customerName }}</h3>
                            <div class="flex items-center gap-1 text-[10px] text-stone-400 truncate">
                                <span class="bg-stone-100 px-1.5 py-0.5 rounded text-stone-500">{{ order.area || 'æœªåˆ†å€' }}</span>
                                <span>${{ order.unitPrice }}/ç“¶</span>
                            </div>
                        </div>
                        
                        <div class="mt-4 pt-3 border-t border-dashed border-stone-100 flex justify-between items-end">
                            <div>
                                <div class="text-emerald-600 font-bold text-xl leading-none tracking-tight">${{ order.totalAmount }}</div>
                                <div class="text-[10px] text-stone-400 mt-1">å…± {{ order.totalCount }} ç“¶</div>
                            </div>
                            
                            <div class="flex gap-1.5 opacity-60 group-hover:opacity-100 transition">
                                <button @click.stop="editOrder(order)" class="w-8 h-8 rounded-full bg-stone-50 text-stone-400 hover:bg-emerald-50 hover:text-emerald-600 transition flex items-center justify-center">
                                    <i class="fas fa-pen text-xs"></i>
                                </button>
                                <button @click.stop="deleteOrder(order.id)" class="w-8 h-8 rounded-full bg-stone-50 text-stone-400 hover:bg-rose-50 hover:text-rose-500 transition flex items-center justify-center">
                                    <i class="fas fa-trash text-xs"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'create'" class="space-y-4 max-w-2xl mx-auto px-1">
                
                <div class="bg-white p-5 rounded-3xl shadow-sm border border-stone-100 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-emerald-400 to-amber-300"></div>
                    
                    <div class="flex flex-col gap-5">
                        <div>
                            <label class="text-xs text-stone-400 font-bold mb-1.5 block tracking-wide">é¡§å®¢å§“å (è‡ªå‹•æœå°‹)</label>
                            <div class="relative">
                                <input type="text" v-model="form.customerName" @input="onNameInput" list="customer-list" class="w-full bg-stone-50 border-0 rounded-2xl py-3 px-4 text-lg font-bold text-stone-700 focus:ring-2 focus:ring-emerald-200 transition placeholder-stone-300" placeholder="è¼¸å…¥å§“å...">
                                <i class="fas fa-search absolute right-4 top-4 text-stone-300"></i>
                            </div>
                            <datalist id="customer-list"><option v-for="c in savedCustomers" :value="c.name"></option></datalist>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-[10px] text-stone-400 font-bold mb-1 block ml-1">åœ°å€</label>
                                <input type="text" v-model="form.area" list="area-options" class="w-full bg-stone-50 border-0 rounded-xl px-3 py-2 text-sm text-stone-600 focus:ring-2 focus:ring-emerald-200">
                                <datalist id="area-options"><option v-for="a in uniqueAreas" :value="a"></option></datalist>
                            </div>
                            <div>
                                <label class="text-[10px] text-stone-400 font-bold mb-1 block ml-1">å–®åƒ¹</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-2 text-stone-400 text-xs">$</span>
                                    <input type="number" v-model.number="form.unitPrice" class="w-full bg-stone-50 border-0 rounded-xl pl-6 pr-3 py-2 text-sm font-bold text-stone-600 focus:ring-2 focus:ring-emerald-200 text-right">
                                </div>
                            </div>
                            <div>
                                <label class="text-[10px] text-stone-400 font-bold mb-1 block ml-1">é¡å‹</label>
                                <select v-model="form.type" class="w-full bg-stone-50 border-0 rounded-xl px-2 py-2 text-sm text-stone-600 focus:ring-2 focus:ring-emerald-200 appearance-none">
                                    <option>æ™¨é–“</option>
                                    <option>å®¶åº­è™Ÿ</option>
                                    <option>åœ˜è³¼</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-[10px] text-stone-400 font-bold mb-1 block ml-1">ç‹€æ…‹</label>
                                <select v-model="form.status" class="w-full bg-stone-50 border-0 rounded-xl px-2 py-2 text-sm text-stone-600 focus:ring-2 focus:ring-emerald-200 appearance-none">
                                    <option>æš«å­˜</option>
                                    <option>å‡ºå¸³</option>
                                    <option>å…¥å¸³</option>
                                </select>
                            </div>
                        </div>

                        <div class="bg-amber-50/60 rounded-2xl p-4 flex justify-between items-center border border-amber-100">
                            <div>
                                <div class="text-[10px] text-amber-500 font-bold uppercase tracking-wider mb-0.5">é ä¼°ç¸½é¡</div>
                                <div class="text-2xl font-bold text-amber-700 tracking-tight">${{ totalAmount.toLocaleString() }}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-[10px] text-amber-500 font-bold uppercase tracking-wider mb-0.5">ç¸½æ•¸é‡</div>
                                <div class="text-xl font-bold text-amber-700">{{ totalCount }} <span class="text-xs font-normal opacity-70">ç“¶</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-2 rounded-2xl border border-stone-200 flex flex-col sm:flex-row items-center justify-between shadow-sm gap-2">
                    <div class="flex items-center gap-2 w-full overflow-x-auto no-scrollbar px-2 py-1">
                        <span class="text-[10px] font-bold text-stone-400 shrink-0 uppercase tracking-wide">é…é€æ—¥</span>
                        <div class="flex gap-1.5">
                            <label v-for="day in [1, 2, 3, 4, 5]" :key="day" :class="['w-9 h-9 rounded-full flex items-center justify-center text-xs font-bold border-2 cursor-pointer select-none transition shrink-0', form.selectedDays.includes(day) ? 'bg-stone-700 text-white border-stone-700 shadow-md transform scale-105' : 'bg-white text-stone-300 border-stone-100 hover:border-stone-300']">
                                <input type="checkbox" :value="day" v-model="form.selectedDays" class="hidden" @change="generateDates">
                                {{ dayMap[day] }}
                            </label>
                        </div>
                    </div>
                    
                    <div class="flex gap-2 w-full sm:w-auto px-2 pb-1 sm:pb-0">
                         <button @click="batchChangeVisible" class="btn-press flex-1 sm:flex-none text-xs bg-amber-100 text-amber-700 px-4 py-2 rounded-xl font-bold hover:bg-amber-200 transition flex items-center justify-center gap-1">
                            <i class="fas fa-bolt"></i> æ‰¹æ¬¡å¾ªç’°
                        </button>
                        <button @click="toggleAllYear" class="btn-press flex-1 sm:flex-none text-xs bg-stone-100 text-stone-600 px-4 py-2 rounded-xl font-bold hover:bg-stone-200 transition flex items-center justify-center gap-1">
                            <i class="fas fa-check-double"></i> å…¨å¹´
                        </button>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-3xl border border-stone-100 shadow-sm group relative">
                    <div class="flex justify-between items-center mb-2 px-1">
                        <label class="text-xs font-bold text-stone-400 flex items-center gap-1"><i class="fas fa-comment-alt"></i> é€šçŸ¥æ–‡æ¡ˆ</label>
                        <div class="flex gap-2">
                            <button @click="saveOrder" :disabled="isSaving" class="btn-press text-[10px] bg-emerald-500 text-white px-4 py-1.5 rounded-full shadow-md shadow-emerald-200 hover:bg-emerald-600 transition font-bold flex items-center gap-1 disabled:opacity-50 disabled:shadow-none">
                                <i class="fas fa-save"></i> å„²å­˜è¨‚å–®
                            </button>
                            <button @click="copyBill" class="btn-press text-[10px] bg-white border border-stone-200 text-stone-500 hover:text-indigo-600 px-3 py-1.5 rounded-full transition font-bold">
                                <i class="far fa-copy"></i> è¤‡è£½
                            </button>
                        </div>
                    </div>
                    <textarea readonly v-model="generatedBillText" class="w-full h-32 text-xs font-mono bg-stone-50 border-0 rounded-2xl p-4 text-stone-600 outline-none resize-none focus:bg-white focus:ring-2 focus:ring-indigo-100 transition select-all leading-relaxed"></textarea>
                </div>

                <div class="grid grid-cols-3 gap-2 pb-8">
                    <div v-for="(monthData, mIndex) in monthsGrid" :key="mIndex" class="bg-white border border-stone-100 rounded-2xl overflow-hidden flex flex-col h-full hover:border-emerald-200 transition-colors shadow-sm">
                        <div class="bg-stone-50/50 p-2 text-center border-b border-stone-50 flex justify-between items-center px-2">
                            <span class="text-[10px] font-bold text-stone-500">{{ monthData.title }}</span>
                            <span v-if="monthData.total > 0" class="text-[9px] bg-emerald-100 text-emerald-700 px-1.5 py-0.5 rounded-full font-bold">{{ monthData.total }}</span>
                        </div>
                        <div class="p-1.5 grid grid-cols-3 gap-1 content-start flex-1">
                            <div v-for="d in monthData.days" :key="d.fullDate" 
                                 @click="toggleDateQty(d)"
                                 :class="['aspect-square rounded-xl flex flex-col items-center justify-center relative cursor-pointer select-none border transition-all duration-200',
                                    d.qty > 0 ? 'bg-emerald-500 border-emerald-500 shadow-md shadow-emerald-200 scale-105 z-10' : 'bg-white border-stone-50 hover:border-stone-200'
                                 ]">
                                <span :class="['text-[10px] font-bold leading-none', d.qty > 0 ? 'text-white' : 'text-stone-600']">{{ d.dateStr }}</span>
                                <span :class="['text-[8px] scale-90 mt-0.5', d.qty > 0 ? 'text-emerald-100' : 'text-stone-300']">{{ d.dayStr }}</span>
                                
                                <div v-if="d.qty > 0" class="qty-badge absolute -top-1.5 -right-1.5 w-4 h-4 bg-white text-emerald-600 rounded-full flex items-center justify-center text-[9px] font-bold shadow-sm border border-emerald-100">
                                    {{ d.qty }}
                                </div>
                            </div>
                            <div v-if="monthData.days.length === 0" class="col-span-3 flex items-center justify-center h-full min-h-[40px] opacity-30">
                                <i class="fas fa-slash text-[10px] text-stone-200"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </main>

        <transition name="fade">
            <div v-if="modal.show" class="fixed inset-0 z-[60] flex items-center justify-center bg-stone-800/40 backdrop-blur-sm p-4" @click.self="closeModal">
                <transition name="scale">
                    <div v-if="modal.show" class="bg-white rounded-3xl shadow-2xl max-w-sm w-full overflow-hidden flex flex-col p-1">
                        <div :class="['px-6 py-5 flex items-center gap-4 border-b border-dashed rounded-t-3xl', modal.type === 'error' ? 'bg-rose-50 border-rose-100' : 'bg-emerald-50 border-emerald-100']">
                            <div :class="['w-12 h-12 rounded-2xl flex items-center justify-center shrink-0 text-xl shadow-sm', modal.type === 'error' ? 'bg-white text-rose-500' : 'bg-white text-emerald-500']">
                                <i :class="modal.type === 'error' ? 'fas fa-bomb' : 'fas fa-check-circle'"></i>
                            </div>
                            <h3 :class="['font-bold text-lg', modal.type === 'error' ? 'text-rose-700' : 'text-emerald-800']">
                                {{ modal.title }}
                            </h3>
                        </div>
                        <div class="p-6">
                            <div class="bg-stone-50 p-4 rounded-2xl border border-stone-100">
                                <p class="text-sm text-stone-600 font-mono break-all whitespace-pre-wrap select-all leading-relaxed">{{ modal.message }}</p>
                            </div>
                        </div>
                        <div class="px-6 pb-6 flex gap-3">
                            <button @click="copyModalContent" class="btn-press flex-1 bg-white border border-stone-200 text-stone-600 py-3 rounded-2xl font-bold hover:bg-stone-50 transition flex justify-center items-center gap-2">
                                <i class="far fa-copy"></i> è¤‡è£½
                            </button>
                            <button @click="closeModal" :class="['btn-press flex-1 py-3 rounded-2xl font-bold text-white shadow-lg transition', modal.type === 'error' ? 'bg-rose-500 hover:bg-rose-600 shadow-rose-200' : 'bg-stone-800 hover:bg-stone-900 shadow-stone-300']">
                                äº†è§£
                            </button>
                        </div>
                    </div>
                </transition>
            </div>
        </transition>

    </div>

    <script type="module">
        import { createApp, ref, computed, reactive, onMounted } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref as dbRef, push, onValue, remove, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyB6D9vh6J2mdnjz2VXEVe99oi7oLF-irFo",
            authDomain: "crm-ts-1225-001.firebaseapp.com",
            databaseURL: "https://crm-ts-1225-001-default-rtdb.firebaseio.com",
            projectId: "crm-ts-1225-001",
            storageBucket: "crm-ts-1225-001.firebasestorage.app",
            messagingSenderId: "925760221722",
            appId: "1:925760221722:web:1aeda0b82f1f16b8dcd7a3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        createApp({
            setup() {
                const currentTab = ref('list');
                const loading = ref(true);
                const isSaving = ref(false);
                const editMode = ref(false);
                const currentOrderId = ref(null);
                const dayMap = { 1: 'ä¸€', 2: 'äºŒ', 3: 'ä¸‰', 4: 'å››', 5: 'äº”' };
                const modal = reactive({ show: false, title: '', message: '', type: 'info' });

                const orders = ref([]);
                const savedCustomers = ref([]);
                const form = reactive({ customerName: '', area: '', unitPrice: 145, status: 'æš«å­˜', type: 'æ™¨é–“', selectedDays: [1] });
                const dateList = ref([]);

                const showModal = (title, message, type = 'success') => { modal.title = title; modal.message = message; modal.type = type; modal.show = true; };
                const closeModal = () => { modal.show = false; };
                const copyModalContent = () => { navigator.clipboard.writeText(modal.message); };
                const reloadPage = () => { window.location.reload(); };

                const toSafeKey = (dateStr) => dateStr.replace(/\//g, '-');
                const fromSafeKey = (keyStr) => keyStr.replace(/-/g, '/');

                const generateDates = () => {
                    try {
                        const tempDates = [];
                        const start = new Date(2025, 0, 1);
                        const end = new Date(2025, 11, 31);
                        const activeDays = new Set(form.selectedDays); 
                        
                        const existingMap = new Map();
                        dateList.value.forEach(d => { if(d.qty > 0) existingMap.set(d.fullDate, d.qty); });

                        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                            const day = d.getDay();
                            if (activeDays.has(day)) {
                                const y = d.getFullYear();
                                const m = d.getMonth();
                                const dd = d.getDate();
                                const mStr = (m + 1).toString().padStart(2, '0');
                                const dStr = dd.toString().padStart(2, '0');
                                const fDate = `${y}/${mStr}/${dStr}`;
                                
                                const weekNum = getWeekNumber(d);

                                tempDates.push({
                                    fullDate: fDate, monthIndex: m, dateStr: dStr, dayStr: dayMap[day],
                                    qty: existingMap.get(fDate) || 0,
                                    weekNum: weekNum
                                });
                            }
                        }
                        dateList.value = tempDates;
                    } catch (e) { showModal('æ—¥æœŸéŒ¯èª¤', e.message, 'error'); }
                };

                function getWeekNumber(d) {
                    const date = new Date(d.getTime());
                    date.setHours(0, 0, 0, 0);
                    date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
                    const week1 = new Date(date.getFullYear(), 0, 4);
                    return 1 + Math.round(((date.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
                }

                const monthsGrid = computed(() => {
                    const grid = Array.from({ length: 12 }, (_, i) => ({ title: `2025-${(i + 1).toString().padStart(2, '0')}`, days: [], total: 0 }));
                    dateList.value.forEach(d => {
                        if(grid[d.monthIndex]) { grid[d.monthIndex].days.push(d); grid[d.monthIndex].total += d.qty; }
                    });
                    return grid;
                });

                const toggleDateQty = (d) => { if (d.qty === 0) d.qty = 1; else if (d.qty === 1) d.qty = 1.5; else if (d.qty === 1.5) d.qty = 2; else if (d.qty === 2) d.qty = 0.5; else d.qty = 0; };

                const batchChangeVisible = () => {
                    if (dateList.value.length === 0) return;
                    const firstQty = dateList.value[0].qty;
                    let nextQty = 0;
                    if (firstQty === 0) nextQty = 1; else if (firstQty === 1) nextQty = 1.5; else if (firstQty === 1.5) nextQty = 2; else if (firstQty === 2) nextQty = 0.5; else nextQty = 0;
                    dateList.value.forEach(d => d.qty = nextQty);
                };

                const toggleAllYear = () => {
                    const hasQty = dateList.value.some(d => d.qty > 0);
                    if(hasQty) {
                        if(confirm('æ¸…é™¤æœ¬å¹´åº¦æ‰€æœ‰å·²é¸æ—¥æœŸï¼Ÿ')) dateList.value.forEach(d => d.qty = 0);
                    } else {
                        dateList.value.forEach(d => d.qty = 1);
                    }
                };

                const generatedBillText = computed(() => {
                    const activeDates = dateList.value.filter(d => d.qty > 0);
                    if (activeDates.length === 0) return 'å°šæœªé¸æ“‡æ—¥æœŸ';
                    
                    const firstDate = activeDates[0].fullDate;
                    const headerMonth = firstDate.substring(0, 7).replace('/', '-');

                    const groupedByMonth = {};
                    activeDates.forEach(d => {
                        const mKey = d.fullDate.substring(0, 7);
                        if (!groupedByMonth[mKey]) groupedByMonth[mKey] = [];
                        groupedByMonth[mKey].push(d);
                    });

                    let details = '';
                    for(const [mKey, dates] of Object.entries(groupedByMonth)) {
                        const [y, m] = mKey.split('/');
                        details += `\nğŸ”ºæ˜ç´°å¦‚ä¸‹ï¼Œ\n${y}å¹´${m}æœˆä»½\n\n`;
                        
                        const groupedByWeek = {};
                        dates.forEach(d => {
                             if(!groupedByWeek[d.weekNum]) groupedByWeek[d.weekNum] = [];
                             groupedByWeek[d.weekNum].push(d);
                        });

                        Object.keys(groupedByWeek).sort((a,b)=>a-b).forEach(wk => {
                            const weekDates = groupedByWeek[wk];
                            const lineStr = weekDates.map(d => {
                                const dayNum = parseInt(d.dateStr);
                                const monthNum = parseInt(m);
                                const qText = d.qty !== 1 ? ` (x${d.qty})` : '';
                                return `${monthNum}/${d.dateStr} (${d.dayStr})${qText}`;
                            }).join('ï¼Œ');
                            
                            details += `${lineStr}\n`;
                        });
                    }

                    return `å ±å‘Š ${form.customerName}ï¼Œ${headerMonth}æœˆ\n\nâœ…è²»ç”¨ï¼š$${totalAmount.value} (å…±${totalCount.value}ç“¶)\n\nğŸ”¸è«‹åƒè€ƒä»¥ä¸‹æ˜ç´°, \nè‹¥æœ‰ç–‘å•æˆ‘ç›¡é€Ÿä¿®æ­£ï¼Œæ„Ÿè¬ğŸ™\n${details}\næ‘˜è¦çµæŸã€‚`;
                });

                const copyBill = () => { navigator.clipboard.writeText(generatedBillText.value).then(() => showModal('è¤‡è£½æˆåŠŸ', 'å¸³å‹™æ‘˜è¦å·²è¤‡è£½')); };

                const saveOrder = async () => {
                    if (!form.customerName) { showModal('æ¬„ä½ç¼ºæ¼', 'è«‹è¼¸å…¥é¡§å®¢å§“å', 'error'); return; }
                    isSaving.value = true;
                    try {
                        const activeDates = dateList.value.filter(d => d.qty > 0);
                        const datesObj = activeDates.reduce((acc, curr) => { acc[toSafeKey(curr.fullDate)] = curr.qty; return acc; }, {});
                        const payload = {
                            customerName: form.customerName, area: form.area, unitPrice: form.unitPrice, 
                            status: form.status, type: form.type,
                            selectedDays: form.selectedDays,
                            totalAmount: totalAmount.value, totalCount: totalCount.value, dates: datesObj, updatedAt: new Date().toISOString()
                        };
                        if (editMode.value && currentOrderId.value) await update(dbRef(db, `orders/${currentOrderId.value}`), payload);
                        else { payload.createdAt = new Date().toISOString(); await push(dbRef(db, 'orders'), payload); }
                        
                        const key = btoa(encodeURIComponent(form.customerName)).replace(/[^a-zA-Z0-9]/g, '');
                        await update(dbRef(db, `customers/${key}`), { 
                            name: form.customerName, area: form.area, unitPrice: form.unitPrice,
                            type: form.type, status: form.status 
                        });
                        showModal('å„²å­˜æˆåŠŸ', `è¨‚å–®å·²${editMode.value?'æ›´æ–°':'å»ºç«‹'}å®Œç•¢`, 'success');
                        switchTab('list');
                    } catch (e) { showModal('å„²å­˜å¤±æ•—', e.message, 'error'); } finally { isSaving.value = false; }
                };

                const editOrder = (o) => {
                    try {
                        editMode.value = true; currentOrderId.value = o.id;
                        form.customerName = o.customerName; form.area = o.area || ''; form.unitPrice = o.unitPrice; 
                        form.status = (o.status && o.status.length<=2) ? o.status : 'æš«å­˜';
                        form.type = o.type || 'æ™¨é–“'; 
                        form.selectedDays = o.selectedDays || [1];
                        generateDates();
                        if(o.dates) dateList.value.forEach(d => { const safeKey = toSafeKey(d.fullDate); d.qty = o.dates[safeKey] || 0; });
                        switchTab('create');
                    } catch (e) { showModal('è¼‰å…¥éŒ¯èª¤', e.message, 'error'); }
                };

                const deleteOrder = async (id) => {
                    if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨‚å–®å—ï¼Ÿ')) {
                        try { await remove(dbRef(db, `orders/${id}`)); } catch(e) { showModal('åˆªé™¤å¤±æ•—', e.message, 'error'); }
                    }
                };
                
                const onNameInput = () => { 
                    const f = savedCustomers.value.find(c => c.name === form.customerName); 
                    if (f) { 
                        form.area = f.area || ''; 
                        form.unitPrice = f.unitPrice || 145; 
                        if(f.type) form.type = f.type;
                        if(f.status) form.status = f.status;
                    } 
                };
                const createMockData = async () => {
                    try {
                        const mocks = [{name:'æ¸¬è©¦å®¢A',price:145,st:'æš«å­˜', tp:'æ™¨é–“'}, {name:'æ¸¬è©¦å®¢B',price:145,st:'å‡ºå¸³', tp:'åœ˜è³¼'}];
                        for(const m of mocks) await push(dbRef(db, 'orders'), { 
                            customerName: m.name, unitPrice: m.price, status: m.st, type: m.tp,
                            totalAmount: 290, totalCount: 2, dates: {'2025-01-01': 2}, createdAt: new Date().toISOString() 
                        });
                        showModal('å»ºç«‹æˆåŠŸ', 'å·²ç”Ÿæˆæ¸¬è©¦è³‡æ–™', 'success');
                    } catch (e) { showModal('ç”Ÿæˆå¤±æ•—', e.message, 'error'); }
                };

                const switchTab = (t) => {
                    if (t === 'create' && !editMode.value) { 
                        form.customerName=''; form.area=''; form.unitPrice=145; form.status='æš«å­˜'; form.type='æ™¨é–“'; form.selectedDays=[1]; 
                        generateDates(); 
                    } 
                    else if (t === 'list') { editMode.value = false; currentOrderId.value = null; }
                    currentTab.value = t;
                };
                const switchToCreate = () => { editMode.value = false; switchTab('create'); };

                onMounted(() => {
                    onValue(dbRef(db, 'orders'), (s) => { const d = s.val(); orders.value = d ? Object.entries(d).map(([k, v]) => ({ id: k, ...v })) : []; loading.value = false; }, (e) => showModal('é€£ç·šéŒ¯èª¤', e.message, 'error'));
                    onValue(dbRef(db, 'customers'), (s) => { savedCustomers.value = s.val() ? Object.values(s.val()) : []; });
                    generateDates();
                });

                const totalCount = computed(() => dateList.value.reduce((s, d) => s + d.qty, 0));
                const totalAmount = computed(() => Math.floor(totalCount.value * form.unitPrice));
                const sortedOrders = computed(() => [...orders.value].sort((a,b) => new Date(b.updatedAt||b.createdAt)-new Date(a.updatedAt||a.createdAt)));
                const uniqueAreas = computed(() => [...new Set(savedCustomers.value.map(c => c.area).filter(Boolean))]);
                const getStatusClass = (s) => s==='å‡ºå¸³'?'status-billed':(s==='å…¥å¸³'?'status-paid':'status-save');
                const getTypeClass = (t) => t==='åœ˜è³¼'?'type-group':(t==='å®¶åº­è™Ÿ'?'type-family':'type-morning');

                return {
                    pageTitle: computed(() => currentTab.value === 'list' ? 'è¨‚å–®ç®¡ç†' : (editMode.value ? 'ä¿®æ”¹è¨‚å–®' : 'æ–°å¢è¨‚å–®')),
                    currentTab, loading, isSaving, editMode, switchTab, switchToCreate,
                    form, savedCustomers, uniqueAreas, onNameInput, dayMap, generateDates,
                    monthsGrid, toggleDateQty, modal, showModal, closeModal, copyModalContent,
                    totalCount, totalAmount, generatedBillText, copyBill, batchChangeVisible, toggleAllYear,
                    sortedOrders, saveOrder, editOrder, deleteOrder,
                    getStatusClass, getTypeClass, createMockData, reloadPage
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
