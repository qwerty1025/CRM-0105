<script type="module">
        import { createApp, ref, computed, reactive, onMounted, watch } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref as dbRef, push, onValue, remove, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyB6D9vh6J2mdnjz2VXEVe99oi7oLF-irFo",
            authDomain: "crm-ts-1225-001.firebaseapp.com",
            databaseURL: "https://crm-ts-1225-001-default-rtdb.firebaseio.com",
            projectId: "crm-ts-1225-001",
            storageBucket: "crm-ts-1225-001.firebasestorage.app",
            messagingSenderId: "925760221722",
            appId: "1:925760221722:web:1aeda0b82f1f16b8dcd7a3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        createApp({
            setup() {
                const currentTab = ref('list');
                const loading = ref(true);
                const isSaving = ref(false);
                const editMode = ref(false);
                const currentOrderId = ref(null);
                const dayMap = { 1: '‰∏Ä', 2: '‰∫å', 3: '‰∏â', 4: 'Âõõ', 5: '‰∫î', 6: 'ÂÖ≠', 0: 'Êó•' };
                
                // ‚òÖ ‰øÆÊîπÈªû 1ÔºöÁµ¶‰∫à Modal È†êË®≠ÂÄºÔºåÈÅøÂÖç undefined ÈåØË™§
                const modal = reactive({ 
                    show: false, 
                    title: 'Á≥ªÁµ±ÊèêÁ§∫', 
                    message: 'ËºâÂÖ•‰∏≠...', 
                    type: 'info' 
                });
                
                const copyMode = ref('A');
                const fileInput = ref(null);

                const orders = ref([]);
                const savedCustomers = ref([]);
                const statusOptions = ['Êö´Â≠ò', 'Â∑≤ÈÄöÁü•', 'Â∑≤Âá∫Â∏≥', 'Â∑≤Êî∂Ê¨æ'];
                const filterStatus = ref([...statusOptions]); 

                const form = reactive({ 
                    customerName: '', area: '', 
                    priceA: 30, priceB: 160, unitPrice: 30, 
                    status: 'Êö´Â≠ò', type: 'Êô®Èñì', selectedDays: [1] 
                });
                const activePrice = ref('A');
                const dateList = ref([]);

                // ‚òÖ ‰øÆÊîπÈªû 2ÔºöÂáΩÂºèÂèÉÊï∏È†êË®≠ÂÄº (Default Parameters)
                const showModal = (title = 'Á≥ªÁµ±ÈÄöÁü•', message = 'Êìç‰ΩúÂÆåÊàê', type = 'success') => { 
                    modal.title = title || 'Á≥ªÁµ±ÈÄöÁü•'; // ÈõôÈáç‰øùÈö™
                    modal.message = message || 'ÁÑ°ÂÖßÂÆπ'; 
                    modal.type = type || 'info'; 
                    modal.show = true; 
                };
                
                const closeModal = () => { modal.show = false; };
                const copyModalContent = () => navigator.clipboard.writeText(modal.message);
                const reloadPage = () => window.location.reload();

                // ÂåØÂÖ•ÂåØÂá∫
                const exportData = () => {
                    const dataStr = JSON.stringify(orders.value, null, 2);
                    const blob = new Blob([dataStr], { type: "application/json" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `crm_backup_${new Date().toISOString().slice(0,10)}.json`;
                    a.click();
                };
                const triggerImport = () => fileInput.value.click();
                const handleImport = (e) => {
                    const file = e.target.files[0];
                    if(!file) return;
                    const reader = new FileReader();
                    reader.onload = async (ev) => {
                        try {
                            const data = JSON.parse(ev.target.result);
                            if(Array.isArray(data)) {
                                if(confirm(`Âç≥Â∞áÂåØÂÖ• ${data.length} Á≠ÜË≥áÊñôÔºåÈÄôÂ∞áÊñ∞Â¢ûÂà∞ÁèæÊúâË≥áÊñôÂ∫´‰∏≠ÔºåÁ¢∫ÂÆöÂóéÔºü`)) {
                                    for(const item of data) {
                                        const { id, ...cleanItem } = item;
                                        await push(dbRef(db, 'orders'), cleanItem);
                                    }
                                    showModal('ÂåØÂÖ•ÊàêÂäü', `ÊàêÂäüÂåØÂÖ• ${data.length} Á≠ÜË≥áÊñô`);
                                }
                            } else showModal('Ê†ºÂºèÈåØË™§', 'Ê™îÊ°àÂÖßÂÆπÂøÖÈ†àÊòØÈô£Âàó');
                        } catch(err) { showModal('ÂåØÂÖ•Â§±Êïó', err.message); }
                    };
                    reader.readAsText(file);
                };

                const toSafeKey = (d) => d.replace(/\//g, '-');
                
                const generateDates = () => {
                    const temp = [];
                    const start = new Date(2025, 0, 1);
                    const end = new Date(2025, 11, 31);
                    const activeDays = new Set(form.selectedDays); 
                    const existing = new Map();
                    dateList.value.forEach(d => { if(d.qty > 0) existing.set(d.fullDate, d.qty); });

                    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                        if (activeDays.has(d.getDay())) {
                            const y = d.getFullYear();
                            const m = d.getMonth();
                            const dd = d.getDate();
                            const mStr = (m + 1).toString().padStart(2, '0');
                            const dStr = dd.toString().padStart(2, '0');
                            const fDate = `${y}/${mStr}/${dStr}`;
                            
                            const dateObj = new Date(d.getTime());
                            dateObj.setHours(0,0,0,0);
                            dateObj.setDate(dateObj.getDate() + 3 - (dateObj.getDay() + 6) % 7);
                            const w1 = new Date(dateObj.getFullYear(), 0, 4);
                            const wk = 1 + Math.round(((dateObj.getTime() - w1.getTime()) / 86400000 - 3 + (w1.getDay() + 6) % 7) / 7);

                            temp.push({
                                fullDate: fDate, monthIndex: m, dateStr: dStr, dayStr: dayMap[d.getDay()],
                                qty: existing.get(fDate) || 0, weekNum: wk
                            });
                        }
                    }
                    dateList.value = temp;
                };

                const monthsGrid = computed(() => {
                    const grid = Array.from({ length: 12 }, (_, i) => ({ title: `2025-${(i + 1).toString().padStart(2, '0')}`, days: [], total: 0 }));
                    dateList.value.forEach(d => {
                        if(grid[d.monthIndex]) { grid[d.monthIndex].days.push(d); grid[d.monthIndex].total += d.qty; }
                    });
                    return grid;
                });

                const toggleDateQty = (d) => { d.qty = (d.qty===0)?1:(d.qty===1?1.5:(d.qty===1.5?2:(d.qty===2?0.5:0))); };
                const toggleMonth = (days) => {
                    if(days.length === 0) return;
                    const hasQty = days.some(d => d.qty > 0);
                    days.forEach(d => d.qty = hasQty ? 0 : 1);
                };
                const batchChangeVisible = () => {
                    if (dateList.value.length === 0) return;
                    const f = dateList.value[0].qty;
                    let n = (f===0)?1:(f===1?1.5:(f===1.5?2:(f===2?0.5:0)));
                    dateList.value.forEach(d => d.qty = n);
                };
                const setDays = (type) => {
                    if(type === 'weekday') form.selectedDays = [1,2,3,4,5];
                    else form.selectedDays = [0,1,2,3,4,5,6];
                    generateDates();
                };

                const currentPrice = computed(() => activePrice.value === 'A' ? form.priceA : form.priceB);
                const totalCount = computed(() => dateList.value.reduce((s, d) => s + d.qty, 0));
                const totalAmount = computed(() => Math.floor(totalCount.value * currentPrice.value));

                const generatedBillText = computed(() => {
                    const active = dateList.value.filter(d => d.qty > 0);
                    if (active.length === 0) return 'Â∞öÊú™ÈÅ∏ÊìáÊó•Êúü';
                    const firstDate = active[0].fullDate;
                    const header = firstDate.substring(0, 7).replace('/', '-');
                    const byMonth = {};
                    active.forEach(d => {
                        const k = d.fullDate.substring(0, 7);
                        if (!byMonth[k]) byMonth[k] = [];
                        byMonth[k].push(d);
                    });

                    let details = '';
                    if (copyMode.value === 'A') { // ÊòéÁ¥∞Áâà
                        for(const [mKey, dates] of Object.entries(byMonth)) {
                            const [y, m] = mKey.split('/');
                            details += `\nüî∫ ${y}Âπ¥${m}Êúà‰ªΩ\n`;
                            const byWeek = {};
                            dates.forEach(d => { if(!byWeek[d.weekNum]) byWeek[d.weekNum]=[]; byWeek[d.weekNum].push(d); });
                            Object.keys(byWeek).sort((a,b)=>a-b).forEach(wk => {
                                details += byWeek[wk].map(d => `${parseInt(m)}/${d.dateStr}(${d.dayStr})${d.qty!==1?'*'+d.qty:''}`).join('Ôºå') + '\n';
                            });
                        }
                    } else { // ÊúàÁµêÁâà
                        details += '\nÊØèÊó•ÈÖçÈÄÅÔºö(‰æùÊòéÁ¥∞)\n';
                        for(const [mKey, dates] of Object.entries(byMonth)) {
                            const [y, m] = mKey.split('/');
                            const sum = dates.reduce((a,b)=>a+b.qty,0);
                            const days = dates.length;
                            details += `${parseInt(m)} ÊúàÔΩú${days} Â§©ÔºåÂêàË®àÔºö${sum} Áì∂\n\n`;
                        }
                    }
                    return `ÁæäÂ•∂ÈÖçÈÄÅÂ∏≥ÂñÆ\nÔºà${header} Ëµ∑Ôºâ\nÈ°ßÂÆ¢Ôºö${form.customerName}\nË®àÂÉπÔºöÊØèÁì∂ NT$${currentPrice.value}\n${details}‚Äî‚Äî\nÁ∏ΩË®àÔºö${totalCount.value} Áì∂\nÊáâÊî∂ÔºöNT$${totalAmount.value}`;
                });

                const copyBill = () => { navigator.clipboard.writeText(generatedBillText.value).then(() => showModal('Ë§áË£ΩÊàêÂäü', 'Â∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞ø')); };

                const saveOrder = async () => {
                    if (!form.customerName) { showModal('ÈåØË™§', 'Ë´ãËº∏ÂÖ•ÂßìÂêç'); return; }
                    isSaving.value = true;
                    try {
                        const active = dateList.value.filter(d => d.qty > 0);
                        const datesObj = active.reduce((acc, curr) => { acc[toSafeKey(curr.fullDate)] = curr.qty; return acc; }, {});
                        const payload = {
                            customerName: form.customerName, area: form.area, 
                            priceA: form.priceA, priceB: form.priceB, unitPrice: currentPrice.value,
                            status: form.status, type: form.type, selectedDays: form.selectedDays,
                            totalAmount: totalAmount.value, totalCount: totalCount.value, dates: datesObj, updatedAt: new Date().toISOString()
                        };
                        if (editMode.value && currentOrderId.value) await update(dbRef(db, `orders/${currentOrderId.value}`), payload);
                        else { payload.createdAt = new Date().toISOString(); await push(dbRef(db, 'orders'), payload); }
                        
                        const key = btoa(encodeURIComponent(form.customerName)).replace(/[^a-zA-Z0-9]/g, '');
                        await update(dbRef(db, `customers/${key}`), { 
                            name: form.customerName, area: form.area, 
                            priceA: form.priceA, priceB: form.priceB, unitPrice: currentPrice.value,
                            type: form.type, status: form.status 
                        });
                        showModal('ÊàêÂäü', 'ÂÑ≤Â≠òÂÆåÁï¢');
                        switchTab('list');
                    } catch (e) { showModal('Â§±Êïó', e.message); } finally { isSaving.value = false; }
                };

                const editOrder = (o) => {
                    editMode.value = true; currentOrderId.value = o.id;
                    form.customerName = o.customerName; form.area = o.area || ''; 
                    form.priceA = o.priceA || 30; form.priceB = o.priceB || 160; form.unitPrice = o.unitPrice;
                    if(o.unitPrice === o.priceB) activePrice.value = 'B'; else activePrice.value = 'A';

                    form.status = (o.status && o.status.length<=4) ? o.status : 'Êö´Â≠ò';
                    form.type = o.type || 'Êô®Èñì'; form.selectedDays = o.selectedDays || [1];
                    generateDates();
                    if(o.dates) dateList.value.forEach(d => { 
                        const key = d.fullDate.replace(/\//g, '-');
                        d.qty = o.dates[key] || 0; 
                    });
                    switchTab('create');
                };

                const deleteOrder = async (id) => {
                    if(confirm('Á¢∫ÂÆöÂà™Èô§Ôºü')) { await remove(dbRef(db, `orders/${id}`)); }
                };
                
                const onNameInput = () => { 
                    const f = savedCustomers.value.find(c => c.name === form.customerName); 
                    if (f) { 
                        form.area = f.area || ''; 
                        if(f.priceA) form.priceA = f.priceA; 
                        if(f.priceB) form.priceB = f.priceB;
                        form.unitPrice = f.unitPrice || form.priceA;
                        if(form.unitPrice === form.priceB) activePrice.value = 'B'; else activePrice.value = 'A';

                        if(f.type) form.type=f.type; if(f.status) form.status=f.status; 
                    } 
                };
                const createMockData = async () => {
                    const mocks = [{name:'ÈòøÈ≥≥ÂßëÂßë',price:25,st:'Â∑≤Êî∂Ê¨æ',tp:'Êô®Èñì'}];
                    for(const m of mocks) await push(dbRef(db, 'orders'), { 
                        customerName: m.name, unitPrice: m.price, status: m.st, type: m.tp,
                        priceA: 25, priceB: 160,
                        totalAmount: 18250, totalCount: 730, dates: {'2025-01-01': 2}, createdAt: new Date().toISOString() 
                    });
                    showModal('ÊàêÂäü', 'Â∑≤Âª∫Á´ãÁØÑ‰æã');
                };

                const switchTab = (t) => {
                    if (t === 'create' && !editMode.value) { 
                        form.customerName=''; form.area=''; 
                        form.priceA=30; form.priceB=160; form.unitPrice=30; activePrice.value='A';
                        form.status='Êö´Â≠ò'; form.type='Êô®Èñì'; form.selectedDays=[1]; generateDates(); 
                    } 
                    else if (t === 'list') { editMode.value = false; currentOrderId.value = null; }
                    currentTab.value = t;
                };
                const switchToCreate = () => { editMode.value = false; switchTab('create'); };

                onMounted(() => {
                    onValue(dbRef(db, 'orders'), (s) => { const d = s.val(); orders.value = d ? Object.entries(d).map(([k, v]) => ({ id: k, ...v })) : []; loading.value = false; });
                    onValue(dbRef(db, 'customers'), (s) => { savedCustomers.value = s.val() ? Object.values(s.val()) : []; });
                    generateDates();
                });

                const filteredOrders = computed(() => {
                    return orders.value
                        .filter(o => filterStatus.value.includes(o.status))
                        .sort((a,b) => new Date(b.updatedAt||b.createdAt)-new Date(a.updatedAt||a.createdAt));
                });

                const totalCount = computed(() => dateList.value.reduce((s, d) => s + d.qty, 0));
                const totalAmount = computed(() => Math.floor(totalCount.value * currentPrice.value));
                const uniqueAreas = computed(() => [...new Set(savedCustomers.value.map(c => c.area).filter(Boolean))]);
                const getStatusClass = (s) => { switch(s){ case 'Êö´Â≠ò':return 'status-save'; case 'Â∑≤ÈÄöÁü•':return 'status-notified'; case 'Â∑≤Âá∫Â∏≥':return 'status-billed'; case 'Â∑≤Êî∂Ê¨æ':return 'status-paid'; default:return 'status-save'; }};
                const getTypeClass = (t) => { switch(t){ case 'ÂúòË≥º':return 'type-group'; case 'ÂÆ∂Â∫≠Ëôü':return 'type-family'; default:return 'type-morning'; }};

                return {
                    pageTitle: computed(() => currentTab.value === 'list' ? 'Ë®ÇÂñÆÁÆ°ÁêÜ' : (editMode.value ? '‰øÆÊîπË®ÇÂñÆ' : 'Êñ∞Â¢ûË®ÇÂñÆ')),
                    currentTab, loading, isSaving, editMode, switchTab, switchToCreate,
                    form, savedCustomers, uniqueAreas, onNameInput, dayMap, generateDates,
                    monthsGrid, toggleDateQty, modal, showModal, closeModal, copyModalContent,
                    totalCount, totalAmount, generatedBillText, copyBill, batchChangeVisible, toggleMonth, setDays,
                    saveOrder, editOrder, deleteOrder,
                    getStatusClass, getTypeClass, createMockData, reloadPage, copyMode,
                    activePrice, exportData, handleImport, triggerImport, fileInput,
                    statusOptions, filterStatus, filteredOrders
                };
            }
        }).mount('#app');
    </script>