<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>羊奶配送 CRM (模擬展示版)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", "Segoe UI", Roboto, sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .qty-badge { transition: transform 0.2s; }
        .qty-badge.active { transform: scale(1.2); }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden flex flex-col text-slate-800">

    <div id="app" class="flex flex-col h-full w-full">

        <header class="bg-white border-b border-slate-200 px-4 py-3 safe-top flex justify-between items-center shrink-0 z-20 shadow-sm">
            <h1 class="text-lg font-bold flex items-center gap-2 text-slate-800">
                <i class="fas fa-cubes text-indigo-600"></i> 
                {{ pageTitle }}
            </h1>
            <div v-if="orders.length > 0" class="text-xs font-bold bg-indigo-50 text-indigo-600 px-2 py-1 rounded-full">
                {{ orders.length }} 筆資料
            </div>
        </header>

        <main class="flex-1 overflow-y-auto no-scrollbar bg-slate-50 pb-32">
            
            <div v-if="currentTab === 'list'" class="p-4 space-y-4">
                
                <div v-if="orders.length === 0" class="flex flex-col items-center justify-center py-20 text-center">
                    <div class="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center mb-4 text-3xl text-indigo-500">
                        <i class="fas fa-database"></i>
                    </div>
                    <h2 class="text-xl font-bold text-slate-700 mb-2">目前無資料</h2>
                    <p class="text-slate-500 mb-6 text-sm">資料庫連線中，或目前為空。</p>
                    
                    <button @click="loadMockData" class="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-indigo-200 active:scale-95 transition flex items-center gap-2">
                        <i class="fas fa-magic"></i> 載入 8 筆模擬資料
                    </button>
                    <p class="text-xs text-slate-400 mt-4">點擊上方按鈕立即預覽介面</p>
                </div>

                <div v-for="order in sortedOrders" :key="order.id" class="bg-white rounded-xl p-4 shadow-sm border border-slate-200 relative group animate-fade-in">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <div class="flex items-center gap-2">
                                <h3 class="font-bold text-lg text-slate-800">{{ order.customerName }}</h3>
                                <span v-if="order.area" class="text-[10px] px-1.5 py-0.5 bg-slate-100 rounded text-slate-500 border border-slate-200">
                                    {{ order.area }}
                                </span>
                            </div>
                            <div class="text-xs text-slate-400 mt-1 flex items-center gap-1">
                                <span class="bg-blue-50 text-blue-600 px-1.5 rounded">{{ order.group || '一般' }}</span>
                                <span>• ${{ order.unitPrice }}/瓶</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-xl text-indigo-600">${{ order.totalAmount.toLocaleString() }}</div>
                            <div class="text-xs text-slate-500">共 {{ order.totalCount }} 瓶</div>
                        </div>
                    </div>

                    <div class="flex items-center justify-between border-t border-slate-100 pt-3 mt-2">
                        <div class="flex gap-2">
                            <button @click="editOrder(order)" class="text-xs flex items-center gap-1 bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded-lg hover:bg-indigo-100 font-bold">
                                <i class="fas fa-edit"></i> 編輯
                            </button>
                            <button @click="cloneOrder(order)" class="text-xs flex items-center gap-1 bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded-lg hover:bg-emerald-100 font-bold">
                                <i class="fas fa-copy"></i> 複製
                            </button>
                        </div>
                        <button @click="deleteOrder(order.id)" class="text-slate-300 hover:text-red-500 px-2 transition">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'create'" class="p-4 space-y-6">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                    <h3 class="text-xs font-bold text-slate-400 mb-3 uppercase tracking-wider flex justify-between">
                        顧客基本資料
                        <span v-if="editMode" class="text-orange-500">編輯模式</span>
                    </h3>
                    <div class="mb-4 relative">
                        <label class="block text-xs text-slate-500 mb-1">姓名</label>
                        <input type="text" v-model="form.customerName" list="customer-list" @input="onNameInput"
                               class="w-full text-lg font-bold border-b-2 border-slate-200 focus:border-indigo-500 outline-none py-1 bg-transparent" placeholder="輸入姓名">
                        <datalist id="customer-list">
                            <option v-for="c in savedCustomers" :value="c.name">{{ c.area }}</option>
                        </datalist>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-xs text-slate-500 mb-1">地區</label>
                            <input type="text" v-model="form.area" list="area-options" class="w-full bg-slate-50 rounded px-2 py-2 text-sm outline-none">
                             <datalist id="area-options"><option v-for="a in uniqueAreas" :value="a"></option></datalist>
                        </div>
                        <div>
                            <label class="block text-xs text-slate-500 mb-1">族群</label>
                            <input type="text" v-model="form.group" list="group-options" class="w-full bg-slate-50 rounded px-2 py-2 text-sm outline-none">
                             <datalist id="group-options"><option v-for="g in uniqueGroups" :value="g"></option></datalist>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-500 mb-1">單價 ($)</label>
                        <input type="number" v-model.number="form.unitPrice" class="w-full bg-slate-50 rounded px-2 py-2 font-mono font-bold text-right outline-none">
                    </div>
                </div>

                <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-200 flex items-center justify-between">
                    <span class="text-xs font-bold text-slate-500">配送日：</span>
                    <div class="flex gap-2">
                        <div v-for="day in [1, 2, 5]" :key="day">
                            <input type="checkbox" :id="'d-'+day" :value="day" v-model="form.selectedDays" class="hidden day-checkbox" @change="generateDates">
                            <label :for="'d-'+day" :class="['block w-8 h-8 rounded-full border flex items-center justify-center text-xs font-bold cursor-pointer transition select-none',
                                form.selectedDays.includes(day) ? 'bg-indigo-600 text-white border-indigo-600' : 'border-slate-200 text-slate-400']">
                                {{ dayMap[day] }}
                            </label>
                        </div>
                    </div>
                </div>

                <div class="space-y-3">
                    <div v-for="(group, key) in groupedDates" :key="key" class="bg-white rounded-lg overflow-hidden border border-slate-200">
                        <div @click="toggleGroup(key)" class="p-3 bg-slate-50 flex justify-between items-center cursor-pointer">
                            <span class="font-bold text-slate-700 text-sm">{{ key }}</span>
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] bg-indigo-100 text-indigo-700 px-2 rounded-full" v-if="groupTotal(group) > 0">{{ groupTotal(group) }}瓶</span>
                                <i class="fas fa-chevron-down text-xs text-slate-400 transition" :class="{'rotate-180': openGroups[key]}"></i>
                            </div>
                        </div>
                        <div v-show="openGroups[key]" class="p-2 grid grid-cols-5 gap-2">
                            <div v-for="d in group" :key="d.fullDate" @click="toggleDateQty(d)"
                                 :class="['h-14 rounded-lg flex flex-col items-center justify-center relative transition border cursor-pointer select-none',
                                    d.qty > 0 ? 'bg-indigo-50 border-indigo-500' : 'bg-white border-slate-100 text-slate-400'
                                 ]">
                                <span class="text-xs font-bold">{{ d.dateStr }}</span>
                                <span class="text-[10px] scale-90">{{ d.dayStr }}</span>
                                <div v-if="d.qty > 0" class="qty-badge absolute -top-1.5 -right-1.5 w-5 h-5 bg-indigo-600 text-white rounded-full flex items-center justify-center text-xs font-bold shadow-sm">
                                    {{ d.qty }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="h-24"></div>
            </div>
        </main>

        <div v-if="currentTab === 'create'" class="absolute bottom-[70px] left-0 w-full px-4 z-30">
            <div class="bg-white/95 backdrop-blur shadow-2xl rounded-2xl p-4 border border-indigo-100 flex justify-between items-center">
                <div>
                    <div class="text-xs text-slate-500">總配送: {{ totalCount }} 瓶</div>
                    <div class="text-2xl font-bold text-indigo-600">${{ totalAmount.toLocaleString() }}</div>
                </div>
                <div class="flex gap-2">
                    <button v-if="editMode" @click="cancelEdit" class="bg-slate-200 text-slate-600 px-4 py-3 rounded-xl font-bold text-sm">取消</button>
                    <button @click="saveOrder" :disabled="totalCount === 0" 
                        class="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-indigo-200 active:scale-95 transition disabled:bg-slate-300">
                        {{ editMode ? '更新' : '建立' }}
                    </button>
                </div>
            </div>
        </div>

        <nav class="bg-white border-t border-slate-200 safe-bottom flex justify-around items-center py-2 z-40 shrink-0">
            <button @click="switchTab('list')" :class="['flex flex-col items-center p-2 w-1/2 transition', currentTab === 'list' ? 'text-indigo-600' : 'text-slate-400']">
                <i class="fas fa-list-ul text-xl mb-1"></i>
                <span class="text-[10px] font-bold">訂單管理</span>
            </button>
            <div class="w-px h-8 bg-slate-100"></div>
            <button @click="switchTab('create')" :class="['flex flex-col items-center p-2 w-1/2 transition', currentTab === 'create' ? 'text-indigo-600' : 'text-slate-400']">
                <i class="fas fa-plus-circle text-xl mb-1"></i>
                <span class="text-[10px] font-bold">新增/編輯</span>
            </button>
        </nav>

    </div>

    <script type="module">
        import { createApp, ref, computed, reactive, onMounted } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref as dbRef, push, onValue, remove, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Firebase 設定
        const firebaseConfig = {
            apiKey: "AIzaSyB6D9vh6J2mdnjz2VXEVe99oi7oLF-irFo",
            authDomain: "crm-ts-1225-001.firebaseapp.com",
            databaseURL: "https://crm-ts-1225-001-default-rtdb.firebaseio.com",
            projectId: "crm-ts-1225-001",
            storageBucket: "crm-ts-1225-001.firebasestorage.app",
            messagingSenderId: "925760221722",
            appId: "1:925760221722:web:1aeda0b82f1f16b8dcd7a3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        createApp({
            setup() {
                // UI 狀態
                const currentTab = ref('list');
                const editMode = ref(false);
                const currentOrderId = ref(null);
                const openGroups = reactive({});
                const dayMap = { 1: '一', 2: '二', 5: '五' };

                // 資料
                const orders = ref([]);
                const dateList = ref([]);
                const savedCustomers = ref([]); // 顧客資料庫 (Mock or Real)

                // 表單
                const form = reactive({
                    customerName: '',
                    area: '',
                    group: '',
                    unitPrice: 35,
                    selectedDays: [1]
                });

                // --- 模擬資料注入功能 ---
                const loadMockData = () => {
                    const mockData = [
                        { customerName: '王小明', area: '三峽北大', group: '家庭', unitPrice: 35, totalCount: 12, totalAmount: 420 },
                        { customerName: '陳美惠', area: '鶯歌老街', group: '長輩', unitPrice: 35, totalCount: 24, totalAmount: 840 },
                        { customerName: '李志豪', area: '三峽舊區', group: '辦公室', unitPrice: 35, totalCount: 48, totalAmount: 1680 },
                        { customerName: '張雅婷', area: '北大特區', group: '幼兒園', unitPrice: 30, totalCount: 100, totalAmount: 3000 },
                        { customerName: '林春嬌', area: '橫溪', group: '自用', unitPrice: 35, totalCount: 8, totalAmount: 280 },
                        { customerName: '黃阿土', area: '白雞', group: '宮廟', unitPrice: 35, totalCount: 20, totalAmount: 700 },
                        { customerName: 'Everything Cafe', area: '北大', group: '商業', unitPrice: 30, totalCount: 60, totalAmount: 1800 },
                        { customerName: '劉大媽', area: '三峽市場', group: '攤販', unitPrice: 35, totalCount: 4, totalAmount: 140 }
                    ];

                    // 為了即時顯示，直接寫入本地陣列
                    // 若要寫入資料庫，請將下方註解打開 (push 到 Firebase)
                    const now = new Date().toISOString();
                    
                    mockData.forEach(item => {
                        // 產生隨機 ID 模擬
                        const mockId = 'mock_' + Math.random().toString(36).substr(2, 9);
                        orders.value.push({
                            id: mockId,
                            ...item,
                            createdAt: now
                        });
                        
                        // 同步寫入顧客建議清單
                        if(!savedCustomers.value.find(c=>c.name===item.customerName)) {
                            savedCustomers.value.push({ name: item.customerName, area: item.area, group: item.group, unitPrice: item.unitPrice });
                        }
                    });
                    
                    alert("✅ 已成功載入 8 筆模擬資料！");
                };

                // --- 日期生成 ---
                const generateDates = () => {
                    const tempDates = [];
                    const start = new Date(2024, 11, 1);
                    const end = new Date(2025, 11, 31);
                    const activeDays = new Set(form.selectedDays);
                    
                    // 暫存目前的數量設定
                    const qtyMap = new Map();
                    dateList.value.forEach(d => { if(d.qty > 0) qtyMap.set(d.fullDate, d.qty); });

                    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                        const day = d.getDay();
                        if (activeDays.has(day)) {
                            const y = d.getFullYear();
                            const m = (d.getMonth() + 1).toString().padStart(2, '0');
                            const dd = d.getDate().toString().padStart(2, '0');
                            const fDate = `${y}/${m}/${dd}`;
                            
                            tempDates.push({
                                fullDate: fDate,
                                monthGroup: `${y}年 ${m}月`,
                                dateStr: `${m}/${dd}`,
                                dayStr: dayMap[day],
                                qty: qtyMap.get(fDate) || 0
                            });
                        }
                    }
                    dateList.value = tempDates;
                    if(tempDates.length > 0 && Object.keys(openGroups).length === 0) {
                        openGroups[tempDates[0].monthGroup] = true;
                    }
                };

                // --- 交互邏輯 ---
                const toggleDateQty = (d) => { d.qty = d.qty >= 2 ? 0 : d.qty + 1; };
                
                const onNameInput = () => {
                    const found = savedCustomers.value.find(c => c.name === form.customerName);
                    if (found) {
                        form.area = found.area || '';
                        form.group = found.group || '';
                        form.unitPrice = found.unitPrice || 35;
                    }
                };

                // --- CRUD ---
                const saveOrder = async () => {
                    if (!form.customerName) { alert('請輸入姓名'); return; }
                    
                    const activeDates = dateList.value.filter(d => d.qty > 0);
                    const payload = {
                        customerName: form.customerName,
                        area: form.area,
                        group: form.group,
                        unitPrice: form.unitPrice,
                        selectedDays: form.selectedDays,
                        totalAmount: totalAmount.value,
                        totalCount: totalCount.value,
                        dates: activeDates.reduce((acc, curr) => { acc[curr.fullDate] = curr.qty; return acc; }, {}),
                        updatedAt: new Date().toISOString()
                    };

                    try {
                        if (editMode.value && currentOrderId.value) {
                            if(!currentOrderId.value.startsWith('mock_')) {
                                await update(dbRef(db, `orders/${currentOrderId.value}`), payload);
                            } else {
                                // 模擬資料的更新 (僅更新本地)
                                const idx = orders.value.findIndex(o => o.id === currentOrderId.value);
                                if(idx !== -1) orders.value[idx] = { ...orders.value[idx], ...payload };
                            }
                        } else {
                            await push(dbRef(db, 'orders'), { ...payload, createdAt: new Date().toISOString() });
                        }
                        
                        // 本地更新顧客清單
                        if(!savedCustomers.value.find(c=>c.name===form.customerName)) {
                            savedCustomers.value.push({ name: form.customerName, area: form.area, group: form.group, unitPrice: form.unitPrice });
                        }

                        alert('✅ 儲存成功！');
                        resetForm();
                        switchTab('list');
                    } catch (e) {
                        alert('錯誤：' + e.message);
                    }
                };

                const editOrder = (order) => {
                    editMode.value = true;
                    currentOrderId.value = order.id;
                    form.customerName = order.customerName;
                    form.area = order.area;
                    form.group = order.group;
                    form.unitPrice = order.unitPrice;
                    form.selectedDays = order.selectedDays || [1];
                    
                    generateDates(); // 重繪日曆
                    // 回填數量
                    if(order.dates) {
                        dateList.value.forEach(d => {
                            if(order.dates[d.fullDate]) d.qty = order.dates[d.fullDate];
                        });
                    }
                    switchTab('create');
                };

                const cloneOrder = (order) => {
                    editOrder(order);
                    editMode.value = false;
                    currentOrderId.value = null;
                    form.customerName += " (副本)";
                    alert('已複製，請修改姓名後儲存');
                };

                const deleteOrder = (id) => {
                    if(confirm('刪除？')) {
                        if(id.startsWith('mock_')) {
                            orders.value = orders.value.filter(o => o.id !== id);
                        } else {
                            remove(dbRef(db, `orders/${id}`));
                        }
                    }
                };

                const resetForm = () => {
                    form.customerName = ''; form.area = ''; form.group = ''; 
                    form.unitPrice = 35; form.selectedDays = [1];
                    editMode.value = false; currentOrderId.value = null;
                    generateDates();
                };

                const switchTab = (tab) => {
                    currentTab.value = tab;
                    if(tab === 'create' && !editMode.value) generateDates();
                };

                // 初始化
                onMounted(() => {
                    // 嘗試連線 Firebase，但不阻擋畫面
                    onValue(dbRef(db, 'orders'), (snap) => {
                        const data = snap.val();
                        // 這裡採用「合併」邏輯：保留模擬資料 + Firebase資料
                        const remoteOrders = data ? Object.entries(data).map(([k, v]) => ({id: k, ...v})) : [];
                        const mockOrders = orders.value.filter(o => o.id.startsWith('mock_'));
                        orders.value = [...mockOrders, ...remoteOrders];
                    });
                    generateDates();
                });

                // 計算屬性
                const groupedDates = computed(() => dateList.value.reduce((acc, curr) => {
                    if (!acc[curr.monthGroup]) acc[curr.monthGroup] = [];
                    acc[curr.monthGroup].push(curr);
                    return acc;
                }, {}));
                const groupTotal = (group) => group.reduce((sum, d) => sum + d.qty, 0);
                const totalCount = computed(() => dateList.value.reduce((sum, d) => sum + d.qty, 0));
                const totalAmount = computed(() => totalCount.value * form.unitPrice);
                const sortedOrders = computed(() => [...orders.value].sort((a,b) => new Date(b.createdAt||0) - new Date(a.createdAt||0)));
                const uniqueAreas = computed(() => [...new Set(savedCustomers.value.map(c => c.area).filter(Boolean))]);
                const uniqueGroups = computed(() => [...new Set(savedCustomers.value.map(c => c.group).filter(Boolean))]);

                return {
                    pageTitle: computed(() => editMode.value ? '編輯訂單' : (currentTab.value==='list'?'訂單管理':'新增排程')),
                    currentTab, editMode, switchTab, form, 
                    orders, sortedOrders, savedCustomers, uniqueAreas, uniqueGroups,
                    groupedDates, openGroups, toggleGroup: (k) => openGroups[k] = !openGroups[k],
                    toggleDateQty, groupTotal, totalCount, totalAmount,
                    saveOrder, editOrder, cloneOrder, deleteOrder, cancelEdit: () => { resetForm(); switchTab('list'); },
                    onNameInput, generateDates, dayMap, loadMockData
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
